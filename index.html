<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام راصد - ARS</title>

<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&family=Cairo:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Calibri;background:#f4f4f4;margin:0}
.container{
  max-width:550px;margin:40px auto;background:#fff;padding:20px;
  border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.15)
}
h1{text-align:center;color:#d32f2f;margin-bottom:0;font-family:Cairo;font-size:30px}
h2{text-align:center;color:#1976d2;margin-top:4px;font-size:20px;font-weight:bold;font-family:Cairo}

label{display:block;margin-top:10px;font-weight:bold}
input,select{
  width:100%;padding:8px;margin-top:5px;border-radius:6px;border:1px solid #999;
  box-sizing:border-box;font-family:Calibri
}
button{
  width:100%;margin-top:15px;padding:10px;border:none;border-radius:8px;
  background:#1976d2;color:#fff;font-size:16px;font-weight:bold;cursor:pointer
}
button:hover{opacity:0.9}

.role-box{display:flex;justify-content:space-between;margin-top:10px}
.role-box label{font-weight:normal}

.footer{text-align:center;margin-top:15px;font-size:13px;color:#555}
.badge{display:inline-block;padding:3px 8px;border-radius:10px;background:#e3f2fd;color:#0d47a1;font-size:12px;margin-top:8px}

.hidden{display:none}

/* جدول النتيجة */
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:16px}
th,td{border:1px solid #888;padding:8px;text-align:center}
th{background:#1976d2;color:white;font-size:17px}
.blue{color:#0d47a1;font-weight:bold}
.red{color:#d32f2f;font-weight:bold}
</style>
</head>

<body>

<div class="container">

  <h1>نظام راصد</h1>
  <h2>ARS</h2>

  <label>اختر نوع المستخدم</label>
  <div class="role-box">
    <label><input type="radio" name="role" value="superadmin" checked> مشرف عام</label>
    <label><input type="radio" name="role" value="supervisor"> مشرف</label>
    <label><input type="radio" name="role" value="teacher"> معلم</label>
    <label><input type="radio" name="role" value="student"> طالب</label>
  </div>

  <!-- بريد / كلمة مرور -->
  <div id="email_box">
    <label>البريد الإلكتروني</label>
    <input id="email_input" placeholder="example@school.com">
  </div>

  <div id="password_box">
    <label>كلمة المرور</label>
    <input id="password_input" type="password" placeholder="••••••••">
  </div>

  <!-- كود الطالب -->
  <div id="student_code_box" class="hidden">
    <label>كود الطالب</label>
    <input id="student_code_input" placeholder="أدخل كود الطالب">
  </div>

  <button onclick="login()">دخول</button>

  <div class="footer">
    <span class="badge">تصميم محمد عامر أحمد</span>
    <div style="margin-top:5px">الإصدار 2026</div>
  </div>

  <!-- عرض النتيجة يظهر هنا -->
  <div id="result_box" class="hidden" style="margin-top:25px">
<h2 style="text-align:center;color:#0d47a1;font-size:26px;margin:10px 0;">مدارس الفلاح الأهلية</h2>
    <h2 id="exam_type" style="color:#d32f2f;text-align:center"></h2>

    <table id="student_info">
      <tr><th>البيان</th><th>القيمة</th></tr>
      <tr><td class="red">اسم الطالب</td><td id="st_name" class="blue"></td></tr>
      <tr><td class="red">الكود</td><td id="st_code" class="blue"></td></tr>
      <tr><td class="red">الصف</td><td id="st_grade" class="blue"></td></tr>
      <tr><td class="red">الشعبة</td><td id="st_section" class="blue"></td></tr>
    </table>

    <table id="subjects_table">
      <thead>
        <tr>
          <th>المادة</th>
          <th>درجة الطالب</th>
          <th>النهائية</th>
          <th>النسبة</th>
          <th>التقدير</th>
        </tr>
      </thead>
      <tbody id="subjects_body"></tbody>
    </table>

    <table id="summary_table">
      <tr><th>المجموع الكلي</th><th>التقدير العام</th></tr>
      <tr>
        <td id="total_mark" class="blue"></td>
        <td id="final_rating" class="red"></td>
      </tr>
    </table>

    <table id="supervisor_table">
      <tr><th>رئيس الإشراف التربوي</th></tr>
      <tr><td class="blue">أحمد سمير عباس</td></tr>
    </table>

    <table id="manager_table">
      <tr><th>مدير المدرسة</th></tr>
      <tr><td class="blue">سعيد بن علي الجمعان</td></tr>
    </table>

  </div>

</div>


<script>
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* تغيير الحقول */
document.querySelectorAll('input[name="role"]').forEach(r=>{
  r.addEventListener("change",()=>{
    let role=document.querySelector('input[name="role"]:checked').value;

    if(role==="student"){
      email_box.classList.add("hidden");
      password_box.classList.add("hidden");
      student_code_box.classList.remove("hidden");
    }else{
      email_box.classList.remove("hidden");
      password_box.classList.remove("hidden");
      student_code_box.classList.add("hidden");
    }
  });
});

/* دالة التقدير */
function getRate(p){
  if(p>=90)return"ممتاز";
  if(p>=80)return"جيد جدًا";
  if(p>=70)return"جيد";
  if(p>=60)return"مقبول";
  return"ضعيف";
}

/* عرض النتيجة */
async function showResult(code){
  let doc=await db.collection("students").doc(code).get();
  if(!doc.exists){alert("الطالب غير موجود");return;}

  let d=doc.data();

  result_box.classList.remove("hidden");

  exam_type.innerText=d.examType||"—";
  st_name.innerText=d.name||"";
  st_code.innerText=d.code||"";
  st_grade.innerText=d.grade||"";
  st_section.innerText=d.section||"";

  let body=subjects_body;
  body.innerHTML="";
  let subs=d.subjects||{};
  let total=0,totalFull=0;

  Object.keys(subs).forEach(sub=>{
    let m=subs[sub].mark||0;
    let f=subs[sub].fullMark||0;
    let p=f?((m/f)*100).toFixed(0):0;
    let r=getRate(p);

    total+=Number(m);
    totalFull+=Number(f);

    let tr=document.createElement("tr");
    tr.innerHTML=
      "<td>"+sub+"</td>"+
      "<td>"+m+"</td>"+
      "<td>"+f+"</td>"+
      "<td>"+p+"%</td>"+
      "<td>"+r+"</td>";
    body.appendChild(tr);
  });

  total_mark.innerText= totalFull ? (total+" / "+totalFull) : "0 / 0";
  final_rating.innerText= totalFull ? getRate((total/totalFull)*100) : "—";
}

/* تسجيل الدخول */
async function login(){
  let role=document.querySelector('input[name="role"]:checked').value;

  /* الطالب */
  if(role==="student"){
    let code=document.getElementById("student_code_input").value.trim();
    if(!code){alert("أدخل كود الطالب");return;}
    showResult(code);
    return;
  }

  /* الآخرين */
  let email=email_input.value.trim().toLowerCase();
  let password=password_input.value.trim();

  if(!email || !password){
    alert("أدخل البريد الإلكتروني وكلمة المرور");
    return;
  }

  let doc=await db.collection("users").doc(email).get();
  if(!doc.exists){alert("المستخدم غير موجود");return;}

  let data=doc.data();
  if(data.password!==password){alert("كلمة المرور غير صحيحة");return;}
  if(data.role!==role){alert("نوع المستخدم لا يطابق الصلاحيات");return;}

  localStorage.setItem("currentUserEmail",email);
  localStorage.setItem("currentUserRole",data.role);
  localStorage.setItem("currentUserName",data.name||"");

  if(role==="superadmin")location="admin.html";
  if(role==="supervisor")location="supervisor.html";
  if(role==="teacher")location="teacher.html";
}
</script>

</body>
</html>
