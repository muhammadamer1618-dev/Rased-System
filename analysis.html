<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تحليل النتائج - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#eef2f7;
  margin:0;
}

.header{
  background:#1976d2;color:#fff;text-align:center;padding:15px;
  box-shadow:0 2px 5px rgba(0,0,0,0.2)
}
.header h1{margin:0;font-size:26px;font-weight:bold}

.container{max-width:1200px;margin:25px auto;padding:10px}

.box{
  background:#fff;padding:18px;border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);margin-bottom:18px
}

h3{
  margin-top:0;color:#1976d2;font-size:20px;font-weight:bold;
  border-right:4px solid #1976d2;padding-right:8px
}

select,button{
  padding:8px;border-radius:7px;border:1px solid #888;font-size:15px;
  font-family:Calibri;cursor:pointer
}
button{font-weight:bold;background:#1976d2;color:#fff;border:none}

.table-box{overflow-x:auto;margin-top:15px}

table{
  width:100%;border-collapse:collapse;margin-top:10px;font-size:15px
}
th,td{
  border:1px solid #ccc;padding:7px;text-align:center
}
th{background:#1976d2;color:#fff}

.category-title{
  background:#1976d2;color:#fff;padding:6px;border-radius:6px;
  font-weight:bold;margin-top:10px;margin-bottom:6px;text-align:center
}
.count-label{
  color:#1976d2;font-weight:bold;font-size:16px;margin-top:6px;text-align:center
}
</style>
</head>

<body>

<div class="header">
  <h1>تحليل النتائج</h1>
</div>

<div class="container">

  <!-- تحليل فصل واحد -->
  <div class="box">
    <h3>تحليل فصل واحد</h3>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div>
        <label>الصف</label>
        <select id="g1"></select>
      </div>

      <div>
        <label>الشعبة</label>
        <select id="sec1">
          <option value="أ">أ</option>
          <option value="ب">ب</option>
          <option value="ج">ج</option>
        </select>
      </div>

      <div>
        <label>المادة</label>
        <select id="sub1"></select>
      </div>

      <div style="display:flex;align-items:flex-end">
        <button onclick="analyzeSingleClass()">عرض التحليل</button>
      </div>
    </div>

    <div id="single_result"></div>
  </div>

  <!-- مقارنة بين فصول -->
  <div class="box">
    <h3>مقارنة بين 3 فصول لنفس المادة</h3>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div>
        <label>الصف</label>
        <select id="cg1"></select>
      </div>

      <div>
        <label>الشعبة 1</label>
        <select id="csec1">
          <option value="أ">أ</option>
          <option value="ب">ب</option>
          <option value="ج">ج</option>
        </select>
      </div>

      <div>
        <label>الشعبة 2</label>
        <select id="csec2">
          <option value="أ">أ</option>
          <option value="ب">ب</option>
          <option value="ج">ج</option>
        </select>
      </div>

      <div>
        <label>الشعبة 3</label>
        <select id="csec3">
          <option value="أ">أ</option>
          <option value="ب">ب</option>
          <option value="ج">ج</option>
        </select>
      </div>

      <div>
        <label>المادة</label>
        <select id="csub"></select>
      </div>

      <div style="display:flex;align-items:flex-end">
        <button onclick="compareClasses()">عرض المقارنة</button>
      </div>
    </div>

    <div id="compare_result"></div>
  </div>

</div>

<script>
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

var grades=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

function init(){
  grades.forEach(g=>{
    let o1=document.createElement("option");
    o1.value=g;o1.textContent=g;
    g1.appendChild(o1);

    let o2=document.createElement("option");
    o2.value=g;o2.textContent=g;
    cg1.appendChild(o2);
  });
}
init();

/* جلب المواد من صفحة الإعدادات */
async function loadSubjectsForGrade(grade,selectId){
  let sel=document.getElementById(selectId);
  sel.innerHTML="";

  let d=await db.collection("settings").doc("subjects_"+grade).get();
  if(!d.exists){
    sel.innerHTML="<option value=''>لا توجد مواد</option>";
    return;
  }

  let list=d.data().subjects || [];
  list.forEach(s=>{
    let o=document.createElement("option");
    o.textContent=s.name;
    o.value=s.name;
    sel.appendChild(o);
  });
}

g1.addEventListener("change",()=>loadSubjectsForGrade(g1.value,"sub1"));
cg1.addEventListener("change",()=>loadSubjectsForGrade(cg1.value,"csub"));

/* تقسيم الطلاب حسب الفئات */
function categorize(list,full){
  return {
    case: list.filter(x=>x.percent<=50),
    need: list.filter(x=>x.percent>50 && x.percent<=65),
    good: list.filter(x=>x.percent>65 && x.percent<=75),
    very: list.filter(x=>x.percent>75 && x.percent<=85),
    exc: list.filter(x=>x.percent>85 && x.percent<100),
    full: list.filter(x=>x.percent>=100)
  };
}

/* تحليل فصل واحد */
async function analyzeSingleClass(){
  let g=g1.value;
  let sec=sec1.value;
  let sub=sub1.value;

  let q=await db.collection("students")
    .where("grade","==",g)
    .where("section","==",sec)
    .get();

  let list=[];
  q.forEach(d=>{
    let s=d.data();
    let obj=s.subjects[sub];
    if(!obj)return;
    let p=(obj.mark/obj.fullMark)*100;
    list.push({name:s.name,percent:p});
  });

  let fullMark=list[0]?.fullMark||100;

  let cat=categorize(list,fullMark);

  single_result.innerHTML=createSingleTable(cat);
}

function createSingleTable(cat){
  return `
  <div class="table-box">
    <table>
      <tr>
        <th>دراسة حالة<br>${cat.case.length}</th>
        <th>أولى بالرعاية<br>${cat.need.length}</th>
        <th>جيد<br>${cat.good.length}</th>
        <th>جيد جدًا<br>${cat.very.length}</th>
        <th>ممتاز<br>${cat.exc.length}</th>
        <th>الدرجة النهائية<br>${cat.full.length}</th>
      </tr>
      <tr>
        <td>${cat.case.map(x=>x.name).join("<br>")}</td>
        <td>${cat.need.map(x=>x.name).join("<br>")}</td>
        <td>${cat.good.map(x=>x.name).join("<br>")}</td>
        <td>${cat.very.map(x=>x.name).join("<br>")}</td>
        <td>${cat.exc.map(x=>x.name).join("<br>")}</td>
        <td>${cat.full.map(x=>x.name).join("<br>")}</td>
      </tr>
    </table>
  </div>`;
}

/* مقارنة الفصول */
async function compareClasses(){
  let g=cg1.value;
  let subs=[csec1.value,csec2.value,csec3.value];
  let sub=csub.value;

  let outputs=[];

  for(let sec of subs){
    let q=await db.collection("students")
      .where("grade","==",g)
      .where("section","==",sec)
      .get();

    let list=[];
    q.forEach(d=>{
      let s=d.data();
      let obj=s.subjects[sub];
      if(!obj)return;
      let p=(obj.mark/obj.fullMark)*100;
      list.push({name:s.name,percent:p});
    });

    outputs.push({sec,list});
  }

  compare_result.innerHTML=createCompareTable(outputs);
}

function createCompareTable(arr){
  let html=`
  <div class="table-box">
  <table>
    <tr>
      ${arr.map(a=>`<th>${a.sec}</th>`).join("")}
    </tr>

    <tr>
      ${arr.map(a=>`<td>${a.list.map(x=>x.name+" ("+x.percent.toFixed(0)+"%)").join("<br>")}</td>`).join("")}
    </tr>

    <tr>
      ${arr.map(a=>`<td class="count-label">المجموع: ${a.list.length}</td>`).join("")}
    </tr>
  </table>
  </div>`;

  return html;
}
</script>

</body>
</html>
