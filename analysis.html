<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تحليل النتائج - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{
  font-family:Calibri;
  background:#eef2f7;
  margin:0;
}

.header{
  background:#1976d2;
  color:#fff;
  text-align:center;
  padding:15px;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
}
.header h1{ margin:0; font-size:26px; font-weight:bold }

.container{
  max-width:1200px;
  margin:25px auto;
  padding:5px 15px;
}

.box{
  background:#fff;
  border-radius:14px;
  padding:20px;
  margin-bottom:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.12);
}

h3{
  margin-top:0;
  color:#1976d2;
  font-size:20px;
  font-weight:bold;
  border-right:4px solid #1976d2;
  padding-right:8px;
}

/* أزرار */
.btn{
  padding:8px 14px;
  font-size:14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
.btn-primary{ background:#1976d2; color:#fff }
.btn-secondary{ background:#757575; color:#fff }

/* جدول */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-size:14px;
}
th,td{
  border:1px solid #ccc;
  text-align:center;
  padding:6px;
}
th{
  background:#1976d2;
  color:#fff;
  font-size:15px;
}
.category-box{
  background:#f7faff;
  border:1px solid #c9d7f8;
  padding:10px;
  border-radius:10px;
  margin:6px 0;
}
</style>
</head>

<body>

<div class="header">
  <h1>تحليل النتائج - نظام راصد</h1>
</div>

<div class="container">

  <!-- قسم اختيار الفصل الواحد -->
  <div class="box">
    <h3>تحليل فصل واحد</h3>

    <label>الصف</label>
    <select id="grade_single"></select>

    <label>الشعبة</label>
    <select id="section_single"></select>

    <label>المادة</label>
    <select id="subject_single"></select>

    <button class="btn btn-primary" onclick="analyzeSingle()">عرض التحليل</button>

    <canvas id="chart_single" style="margin-top:20px;display:none"></canvas>

    <div id="single_categories"></div>

    <button id="print_single" class="btn btn-secondary" style="margin-top:15px;display:none" onclick="window.print()">طباعة</button>
    <button id="excel_single" class="btn btn-primary" style="margin-top:15px;display:none" onclick="exportSingleExcel()">تصدير Excel</button>
  </div>

  <!-- قسم مقارنة أكثر من فصل -->
  <div class="box">
    <h3>مقارنة بين الفصول</h3>

    <label>اختر الصفوف والمجموعات (حتى 3)</label>
    <div id="compare_area"></div>

    <label>المادة</label>
    <select id="subject_compare"></select>

    <button class="btn btn-primary" onclick="analyzeCompare()">عرض المقارنة</button>

    <canvas id="chart_compare" style="margin-top:20px;display:none"></canvas>

    <button id="print_compare" class="btn btn-secondary" style="margin-top:15px;display:none" onclick="window.print()">طباعة</button>
  </div>

</div>

<script>
/* firebase */
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* تحميل الصفوف والشعب */
async function loadSelectors(){
  let snap=await db.collection("students").get();
  let grades=[...new Set(snap.docs.map(d=>d.data().grade))];
  document.getElementById("grade_single").innerHTML =
    grades.map(g=>`<option>${g}</option>`).join("");

  loadSections();
}
loadSelectors();

async function loadSections(){
  let g=document.getElementById("grade_single").value;
  let snap=await db.collection("students").where("grade","==",g).get();
  let sections=[...new Set(snap.docs.map(d=>d.data().section))];
  document.getElementById("section_single").innerHTML =
    sections.map(s=>`<option>${s}</option>`).join("");

  loadSubjects();
}

async function loadSubjects(){
  let g=document.getElementById("grade_single").value;
  let set=await db.collection("settings").doc("subjects_"+g).get();
  let subs=set.exists? set.data().subjects.map(s=>s.name) : [];
  document.getElementById("subject_single").innerHTML =
    subs.map(s=>`<option>${s}</option>`).join("");
}

/* قسم تحليل فصل واحد */
async function analyzeSingle(){
  let g=document.getElementById("grade_single").value;
  let s=document.getElementById("section_single").value;
  let sub=document.getElementById("subject_single").value;

  let q=await db.collection("students")
    .where("grade","==",g)
    .where("section","==",s).get();

  let list=q.docs.map(d=>d.data());

  let cats={
    case:[],
    care:[],
    good:[],
    verygood:[],
    excellent:[],
    perfect:[]
  };

  list.forEach(st=>{
    let o=st.subjects && st.subjects[sub];
    if(!o)return;

    let p=(o.mark/o.fullMark)*100;

    if(p<50) cats.case.push(st.name);
    else if(p<65) cats.care.push(st.name);
    else if(p<75) cats.good.push(st.name);
    else if(p<85) cats.verygood.push(st.name);
    else if(p<100) cats.excellent.push(st.name);
    else cats.perfect.push(st.name);
  });

  let data=[
    cats.case.length,
    cats.care.length,
    cats.good.length,
    cats.verygood.length,
    cats.excellent.length,
    cats.perfect.length
  ];

  document.getElementById("chart_single").style.display="block";
  new Chart(document.getElementById("chart_single"),{
    type:"bar",
    data:{
      labels:["دراسة حالة","أولى بالرعاية","جيد","جيد جدًا","ممتاز","متفوق"],
      datasets:[{
        label:"عدد الطلاب",
        data:data,
        backgroundColor:["#ef5350","#ff7043","#ffee58","#64b5f6","#4db6ac","#9575cd"]
      }]
    }
  });

  let html="";
  html+=box("دراسة حالة",cats.case);
  html+=box("أولى بالرعاية",cats.care);
  html+=box("جيد",cats.good);
  html+=box("جيد جدًا",cats.verygood);
  html+=box("ممتاز",cats.excellent);
  html+=box("متفوق",cats.perfect);

  document.getElementById("single_categories").innerHTML=html;
  document.getElementById("excel_single").style.display="inline-block";
  document.getElementById("print_single").style.display="inline-block";
}

function box(title,arr){
  return `
    <div class="category-box">
      <strong>${title} (${arr.length})</strong><br>
      ${arr.join(" ، ")}
    </div>
  `;
}

/* Excel */
function exportSingleExcel(){
  let table=document.getElementById("single_categories").innerText;
  let wb=XLSX.utils.book_new();
  let ws=XLSX.utils.aoa_to_sheet([["التقرير"],[table]]);
  XLSX.utils.book_append_sheet(wb,ws,"Report");
  XLSX.writeFile(wb,"analysis.xlsx");
}

/* المقارنة بين الفصول */
async function analyzeCompare(){
  let g=document.getElementById("grade_single").value;
  let sub=document.getElementById("subject_compare").value;

  let snap=await db.collection("students").where("grade","==",g).get();
  let sections=[...new Set(snap.docs.map(d=>d.data().section))];

  let results=[];

  for(let sec of sections){
    let q=await db.collection("students")
      .where("grade","==",g)
      .where("section","==",sec).get();

    let list=q.docs.map(d=>d.data());

    let total=0,count=0;
    list.forEach(st=>{
      let o=st.subjects && st.subjects[sub];
      if(o){ total+=o.mark; count++; }
    });

    let avg=count? (total/count).toFixed(1) : 0;

    results.push({section:sec,avg:Number(avg)});
  }

  document.getElementById("chart_compare").style.display="block";

  new Chart(document.getElementById("chart_compare"),{
    type:"bar",
    data:{
      labels:results.map(r=>r.section),
      datasets:[{
        label:"المعدل العام",
        data:results.map(r=>r.avg),
        backgroundColor:"#1976d2"
      }]
    }
  });

  document.getElementById("print_compare").style.display="inline-block";
}
</script>

</body>
</html>
