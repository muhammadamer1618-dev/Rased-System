<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مقارنة الفصول - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Calibri;
  margin:0;
  background:#eef2f7;
}

.header{
  background:#1976d2;
  color:#fff;
  text-align:center;
  padding:15px;
  font-size:22px;
  font-weight:bold;
}

.container{
  max-width:1100px;
  margin:25px auto;
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,0.12);
}

h2{
  color:#1976d2;
  border-right:5px solid #1976d2;
  padding-right:8px;
  font-size:20px;
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:15px;
  margin-bottom:15px;
}

.sel-box{
  flex:1;
  min-width:200px;
}

label{
  font-weight:bold;
  font-size:15px;
}

select,button{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #999;
  font-size:15px;
  margin-top:5px;
}

button{
  background:#1976d2;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:14px;
}

th,td{
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}

th{
  background:#1976d2;
  color:#fff;
}
</style>
</head>

<body>

<div class="header">مقارنة الفصول حسب المادة</div>

<div class="container">

  <h2>اختيارات المقارنة</h2>

  <div class="row">

    <div class="sel-box">
      <label>الصف</label>
      <select id="cmp_grade"></select>
    </div>

    <div class="sel-box">
      <label>الشعبة أ</label>
      <select id="cmp_sectionA">
        <option>أ</option>
      </select>
    </div>

    <div class="sel-box">
      <label>الشعبة ب</label>
      <select id="cmp_sectionB">
        <option>ب</option>
      </select>
    </div>

    <div class="sel-box">
      <label>الشعبة ج</label>
      <select id="cmp_sectionC">
        <option>ج</option>
      </select>
    </div>

    <div class="sel-box">
      <label>المادة</label>
      <select id="cmp_subject"></select>
    </div>

    <div class="sel-box" style="display:flex;align-items:flex-end">
      <button onclick="compareClasses()">عرض المقارنة</button>
    </div>

  </div>

  <h2>الرسم البياني</h2>
  <canvas id="chart3" height="200"></canvas>

  <h2>تفاصيل كل فصل</h2>

  <table id="table_details" style="display:none">
    <thead>
      <tr>
        <th>الفصل</th>
        <th>الطالب</th>
        <th>الدرجة</th>
        <th>النهائي</th>
        <th>النسبة %</th>
        <th>التقدير</th>
      </tr>
    </thead>
    <tbody id="details_body"></tbody>
  </table>

</div>

<script>
/* FIREBASE */
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* تحميل الصفوف */
let grades=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

grades.forEach(g=>{
  document.getElementById("cmp_grade").innerHTML+=`<option>${g}</option>`;
});

/* تحميل المواد */
async function loadSubjects(){
  let g=document.getElementById("cmp_grade").value;
  let d=await db.collection("settings").doc("subjects_"+g).get();

  let sel=document.getElementById("cmp_subject");
  sel.innerHTML="";

  if(!d.exists)return;

  let list=d.data().subjects||[];
  list.forEach(s=>{
    sel.innerHTML+=`<option>${s.name}</option>`;
  });
}
document.getElementById("cmp_grade").onchange=loadSubjects;
loadSubjects();

function calcRating(p){
  if(p>=90)return"ممتاز";
  if(p>=80)return"جيد جدًا";
  if(p>=70)return"جيد";
  if(p>=60)return"مقبول";
  return"ضعيف";
}

async function getData(grade,section,subject){
  let snap=await db.collection("students")
    .where("grade","==",grade)
    .where("section","==",section)
    .get();

  let list=[];
  let total=0;
  let full=0;

  snap.forEach(doc=>{
    let st=doc.data();
    let s=st.subjects && st.subjects[subject];
    if(!s)return;

    let p=(s.fullMark>0)? (s.mark/s.fullMark*100):0;

    list.push({
      code:st.code,
      name:st.name,
      mark:s.mark,
      full:s.fullMark,
      percent:p,
      rating:calcRating(p),
      section:section
    });

    total+=s.mark;
    full+=s.fullMark;
  });

  let classPercent = full>0 ? (total/full*100).toFixed(1):0;

  return {list,classPercent};
}

async function compareClasses(){

  let g=document.getElementById("cmp_grade").value;
  let sub=document.getElementById("cmp_subject").value;

  let A=await getData(g,"أ",sub);
  let B=await getData(g,"ب",sub);
  let C=await getData(g,"ج",sub);

  drawChart([A.classPercent,B.classPercent,C.classPercent],sub);

  showTable(A.list,"أ");
  showTable(B.list,"ب");
  showTable(C.list,"ج");

}

function drawChart(values,sub){
  let ctx=document.getElementById("chart3").getContext("2d");

  new Chart(ctx,{
    type:"bar",
    data:{
      labels:["أ","ب","ج"],
      datasets:[{
        label:"نسبة الفصل في مادة "+sub+" %",
        data:values,
        backgroundColor:["#1976d2","#d32f2f","#388e3c"]
      }]
    },
    options:{
      indexAxis:"y",
      scales:{x:{min:0,max:100}}
    }
  });
}

function showTable(list,section){
  let body=document.getElementById("details_body");
  document.getElementById("table_details").style.display="table";

  list.forEach(s=>{
    body.innerHTML+=`
      <tr>
        <td>${section}</td>
        <td>${s.name}</td>
        <td>${s.mark}</td>
        <td>${s.full}</td>
        <td>${s.percent.toFixed(1)}</td>
        <td>${s.rating}</td>
      </tr>
    `;
  });
}

</script>

</body>
</html>
