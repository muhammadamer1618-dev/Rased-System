<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تحليل النتائج - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@300;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Calibri;
  background: #eef2f7;
  margin: 0;
}

.header {
  background: #1976d2;
  color: #fff;
  text-align: center;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.header h1 { margin: 0; font-size: 26px; }
.header h2 { margin: 5px 0 0; font-size: 18px; color: #ffeb3b }

.container {
  max-width: 1200px;
  margin: 25px auto;
  padding: 15px;
}

.box {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 18px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.12);
}

h3 {
  margin-top: 0;
  color: #1976d2;
  font-size: 22px;
  font-weight: bold;
  border-right: 4px solid #1976d2;
  padding-right: 8px;
}

select, button {
  padding: 8px;
  font-size: 15px;
  border-radius: 6px;
  border: 1px solid #999;
  margin-top: 6px;
}

button {
  cursor: pointer;
  font-weight: bold;
}
.btn-primary { background:#1976d2;color:#fff }
.btn-secondary { background:#757575;color:#fff }

.grid {
  display: flex;
  gap: 20px;
  overflow-x: auto;
}

.column {
  min-width: 180px;
  background: #fff;
  border-radius: 10px;
  padding: 10px;
  border: 1px solid #bbb;
  box-shadow: 0 1px 5px rgba(0,0,0,0.1);
}

.col-title {
  text-align: center;
  background: #1976d2;
  color: #fff;
  padding: 8px;
  border-radius: 8px;
  font-weight: bold;
  margin-bottom: 10px;
}

.student {
  padding: 5px;
  text-align: center;
  border-bottom: 1px solid #eee;
}

.count-box {
  margin-top: 10px;
  background: #f4f4f4;
  padding: 6px;
  text-align: center;
  border-radius: 6px;
  font-weight: bold;
}

.section-title {
  font-size: 20px;
  font-weight: bold;
  color: #444;
  margin-bottom: 15px;
  text-align: center;
}

</style>
</head>

<body>

<div class="header">
  <h1>نظام راصد</h1>
  <h2>تحليل النتائج</h2>
</div>

<div class="container">

  <div class="box">
    <h3>اختيار صف – شعبة – مادة</h3>

    <label>الصف</label>
    <select id="grade_select"></select>

    <label>الشعبة</label>
    <select id="section_select"></select>

    <label>المادة</label>
    <select id="subject_select"></select>

    <button class="btn-primary" onclick="loadAnalysis()">عرض التحليل</button>
  </div>

  <div class="box" id="result_box" style="display:none">
    <div class="section-title">تحليل نتائج الفصل</div>
    <div id="categories_container" class="grid"></div>
  </div>

  <div class="box">
    <h3>المقارنة بين 3 فصول</h3>

    <label>الصف</label>
    <select id="cmp_grade"></select>

    <label>المادة</label>
    <select id="cmp_subject"></select>

    <label>الشعبة الأولى</label>
    <select id="cmp_s1"></select>

    <label>الشعبة الثانية</label>
    <select id="cmp_s2"></select>

    <label>الشعبة الثالثة</label>
    <select id="cmp_s3"></select>

    <button class="btn-primary" onclick="loadComparison()">عرض المقارنة</button>
  </div>

  <div class="box" id="comparison_box" style="display:none">
    <div class="section-title">المقارنة بين الفصول الثلاثة</div>
    <div id="comparison_container" class="grid"></div>
  </div>

</div>


<script>
/* FIREBASE */
var firebaseConfig = {
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* CONSTANTS */
const categories = [
  { name:"دراسة حالة", from:0, to:50 },
  { name:"أولى بالرعاية", from:50, to:65 },
  { name:"جيد", from:65, to:75 },
  { name:"جيد جدًا", from:75, to:85 },
  { name:"ممتاز", from:85, to:99 },
  { name:"الدرجة النهائية", from:100, to:101 }
];

let gradesList=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

let sectionList=["أ","ب","ج"];

/* INIT */
function init(){
  let g1=document.getElementById("grade_select");
  let g2=document.getElementById("cmp_grade");

  gradesList.forEach(g=>{
    let o=document.createElement("option");
    o.value=g; o.textContent=g;
    g1.appendChild(o.cloneNode(true));
    g2.appendChild(o.cloneNode(true));
  });

  let sec1=document.getElementById("section_select");
  let c1=document.getElementById("cmp_s1");
  let c2=document.getElementById("cmp_s2");
  let c3=document.getElementById("cmp_s3");

  sectionList.forEach(s=>{
    [sec1,c1,c2,c3].forEach(sel=>{
      let o=document.createElement("option");
      o.value=s; o.textContent=s;
      sel.appendChild(o.cloneNode(true));
    });
  });
}
init();

/* LOAD SUBJECTS */
document.getElementById("grade_select").addEventListener("change",async()=>{
  let g=document.getElementById("grade_select").value;
  loadSubjects(g,"subject_select");
});
document.getElementById("cmp_grade").addEventListener("change",async()=>{
  let g=document.getElementById("cmp_grade").value;
  loadSubjects(g,"cmp_subject");
});

async function loadSubjects(grade,elementID){
  let d=await db.collection("settings").doc("subjects_"+grade).get();
  let sel=document.getElementById(elementID);
  sel.innerHTML="";
  if(!d.exists) return;
  let subs=d.data().subjects||[];
  subs.forEach(s=>{
    let o=document.createElement("option");
    o.value=s.name;
    o.textContent=s.name;
    o.setAttribute("data-full",s.fullMark);
    sel.appendChild(o);
  });
}

/* GET FULL MARK */
function getFullMark(selectID){
  let sel=document.getElementById(selectID);
  let opt=sel.options[sel.selectedIndex];
  return parseInt(opt.getAttribute("data-full"));
}

/* LOAD ANALYSIS */
async function loadAnalysis(){
  let grade=document.getElementById("grade_select").value;
  let section=document.getElementById("section_select").value;
  let subject=document.getElementById("subject_select").value;

  let fullMark=getFullMark("subject_select");
  if(!fullMark) fullMark=100;

  let q = db.collection("students")
            .where("grade","==",grade)
            .where("section","==",section);

  let snap=await q.get();
  let students=[];
  snap.forEach(doc=>students.push(doc.data()));

  let grouped={};
  categories.forEach(c=>grouped[c.name]=[]);

  students.forEach(st=>{
    let sub = st.subjects && st.subjects[subject];
    if(!sub) return;

    let m = sub.mark || 0;
    let percent = (m/fullMark)*100;

    categories.forEach(c=>{
      if(percent>=c.from && percent<c.to){
        grouped[c.name].push(st.name);
      }
    });
  });

  let container=document.getElementById("categories_container");
  container.innerHTML="";
  document.getElementById("result_box").style.display="block";

  categories.forEach(c=>{
    let div=document.createElement("div");
    div.className="column";

    let title=document.createElement("div");
    title.className="col-title";
    title.textContent=c.name;
    div.appendChild(title);

    grouped[c.name].forEach(name=>{
      let s=document.createElement("div");
      s.className="student";
      s.textContent=name;
      div.appendChild(s);
    });

    let cnt=document.createElement("div");
    cnt.className="count-box";
    cnt.textContent="العدد: "+grouped[c.name].length;
    div.appendChild(cnt);

    container.appendChild(div);
  });
}

/* LOAD COMPARISON */
async function loadComparison(){
  let grade=document.getElementById("cmp_grade").value;
  let subject=document.getElementById("cmp_subject").value;
  let s1=document.getElementById("cmp_s1").value;
  let s2=document.getElementById("cmp_s2").value;
  let s3=document.getElementById("cmp_s3").value;

  let sections=[s1,s2,s3];

  let fullMark=getFullMark("cmp_subject");
  if(!fullMark) fullMark=100;

  let container=document.getElementById("comparison_container");
  container.innerHTML="";
  document.getElementById("comparison_box").style.display="block";

  for(let sec of sections){
    let snap = await db.collection("students")
                       .where("grade","==",grade)
                       .where("section","==",sec)
                       .get();

    let students=[];
    snap.forEach(doc=>students.push(doc.data()));

    let col=document.createElement("div");
    col.className="column";

    let title=document.createElement("div");
    title.className="col-title";
    title.textContent="فصل "+sec;
    col.appendChild(title);

    students.sort((a,b)=>a.name.localeCompare(b.name,"ar"));

    students.forEach(st=>{
      let sub=st.subjects && st.subjects[subject];
      let m=sub?sub.mark:0;
      let div=document.createElement("div");
      div.className="student";
      div.textContent=st.name+" - "+m;
      col.appendChild(div);
    });

    let cnt=document.createElement("div");
    cnt.className="count-box";
    cnt.textContent="العدد: "+students.length;
    col.appendChild(cnt);

    container.appendChild(col);
  }
}

</script>

</body>
</html>
