<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تحليل النتائج - مدارس الفلاح الأهلية</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Calibri;background:#f7f7f7;margin:0}
.container{max-width:1100px;margin:25px auto;padding:10px}

h2{text-align:center;color:#1976d2}
.box{background:#fff;padding:20px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}

.select-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}
select,button{
  padding:8px 12px;
  font-size:15px;
  border-radius:6px;
  border:1px solid #999;
  font-family:Calibri;
}
button{cursor:pointer;font-weight:bold}
.btn-primary{background:#1976d2;color:#fff;border:none}

table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#1976d2;color:#fff}
tr:nth-child(even){background:#f9f9f9}

.title{font-size:18px;font-weight:bold;color:#1976d2;margin-bottom:10px}
.sub-title{font-size:16px;font-weight:bold;margin:10px 0;color:#444;text-decoration:underline}

.col-table-container{
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.col-table{
  flex:1;
  border:1px solid #ddd;
  padding:5px;
  border-radius:8px;
  background:#fff;
}
.col-table h4{text-align:center;margin:5px 0;color:#1976d2;font-size:15px}
.col-table .count{font-size:13px;margin-top:5px;color:#444;text-align:center}
</style>
</head>

<body>

<div class="container">

<h2>تحليل النتائج</h2>

<!-- ========================== تحليل فصل واحد ========================== -->
<div class="box">
  <div class="title">أولاً: تحليل نتائج فصل</div>

  <div class="select-row">
    <select id="grade"></select>
    <select id="section">
      <option value="أ">أ</option>
      <option value="ب">ب</option>
      <option value="ج">ج</option>
    </select>
    <select id="subject"></select>
    <button class="btn-primary" onclick="showAnalysis()">عرض التحليل</button>
  </div>

  <div id="analysis_area"></div>
</div>

<!-- ========================== المقارنة بين الفصول ========================== -->
<div class="box">
  <div class="title">ثانياً: المقارنة بين الفصول</div>

  <div class="select-row">
    <select id="cmp_grade"></select>

    <select id="cmp_s1">
      <option value="">—</option>
      <option>أ</option><option>ب</option><option>ج</option>
    </select>

    <select id="cmp_s2">
      <option value="">—</option>
      <option>أ</option><option>ب</option><option>ج</option>
    </select>

    <select id="cmp_s3">
      <option value="">—</option>
      <option>أ</option><option>ب</option><option>ج</option>
    </select>

    <select id="cmp_subject"></select>

    <button class="btn-primary" onclick="showCompare()">عرض المقارنة</button>
  </div>

  <div id="compare_area"></div>
</div>

</div>

<script>
/* ================= FIREBASE ================== */
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* =============== تعبئة الصفوف =============== */
var gradesList=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

function fillGrades(){
  let g=document.getElementById("grade");
  let cg=document.getElementById("cmp_grade");
  gradesList.forEach(x=>{
    let o=document.createElement("option");
    o.textContent=x;
    g.appendChild(o.cloneNode(true));
    cg.appendChild(o);
  });
}
fillGrades();

/* ========== تحميل المواد من الإعدادات ========== */
async function loadSubjects(grade, target){
  let s=await db.collection("settings").doc("subjects_"+grade).get();
  let sel=document.getElementById(target);
  sel.innerHTML="";
  if(!s.exists)return;

  let list=s.data().subjects||[];
  list.forEach(sub=>{
    let o=document.createElement("option");
    o.value=sub.name;
    o.textContent=sub.name;
    sel.appendChild(o);
  });
}

document.getElementById("grade").onchange=()=>loadSubjects(
  document.getElementById("grade").value,"subject"
);
document.getElementById("cmp_grade").onchange=()=>loadSubjects(
  document.getElementById("cmp_grade").value,"cmp_subject"
);

/* ===================== تحليل فصل واحد ===================== */
async function showAnalysis(){
  let grade=document.getElementById("grade").value;
  let section=document.getElementById("section").value;
  let subject=document.getElementById("subject").value;

  let area=document.getElementById("analysis_area");
  area.innerHTML="جار التحميل...";

  // قراءة الطلاب
  let q=await db.collection("students")
    .where("grade","==",grade)
    .where("section","==",section)
    .get();

  let students=[];
  q.forEach(d=>students.push(d.data()));

  // تصنيفات
  let cats={
    "دراسة حالة":[],
    "أولى بالرعاية":[],
    "جيد":[],
    "جيد جدًا":[],
    "ممتاز":[],
    "الدرجة النهائية":[]
  };

  let total=0, full=0;

  students.forEach(st=>{
    let s=st.subjects && st.subjects[subject];
    if(!s)return;

    // *** تعديل مهم: تجاهل الطالب الذي درجته صفر أو غير مرصودة ***
    if (!s.mark || s.mark <= 0) return;

    total+=s.mark;
    full+=s.fullMark;

    let pct=(s.mark/s.fullMark)*100;

    if(s.mark===s.fullMark) cats["الدرجة النهائية"].push(st.name);
    else if(pct<50) cats["دراسة حالة"].push(st.name);
    else if(pct<65) cats["أولى بالرعاية"].push(st.name);
    else if(pct<75) cats["جيد"].push(st.name);
    else if(pct<85) cats["جيد جدًا"].push(st.name);
    else cats["ممتاز"].push(st.name);
  });

  let overall = full? ((total/full)*100).toFixed(1):"—";

  // بناء الجداول
  let html=`<div class="sub-title">الصف: ${grade} — الشعبة: ${section} — المادة: ${subject}</div>`;
  html+=`<div class="col-table-container">`;

  for(const cat in cats){
    html+=`
      <div class="col-table">
        <h4>${cat}</h4>
        ${cats[cat].map(n=>"<div>"+n+"</div>").join("") || "<div>—</div>"}
        <div class="count">العدد: ${cats[cat].length}</div>
      </div>
    `;
  }
  html+=`</div>`;

  html+=`
    <table>
      <tr><th>النسبة المئوية لدرجات الفصل</th></tr>
      <tr><td>${overall}%</td></tr>
    </table>
  `;

  area.innerHTML=html;
}

/* ===================== المقارنة بين الفصول ===================== */
async function showCompare(){
  let grade=document.getElementById("cmp_grade").value;
  let subject=document.getElementById("cmp_subject").value;
  let s1=document.getElementById("cmp_s1").value;
  let s2=document.getElementById("cmp_s2").value;
  let s3=document.getElementById("cmp_s3").value;

  let groups=[s1,s2,s3].filter(x=>x);

  let area=document.getElementById("compare_area");
  area.innerHTML="جار التحميل...";

  let rows="";

  for(let s of groups){
    let q=await db.collection("students")
      .where("grade","==",grade)
      .where("section","==",s)
      .get();

    let total=0, full=0;

    q.forEach(d=>{
      let st=d.data();
      let sub=st.subjects && st.subjects[subject];

      // *** تجاهل الصفر ***
      if(sub && sub.mark > 0){
        total+=sub.mark;
        full+=sub.fullMark;
      }
    });

    let pct=full? ((total/full)*100).toFixed(1) : "—";

    rows+=`
      <tr>
        <td>${pct}%</td>
        <td>${grade} فصل ${s}</td>
      </tr>
    `;
  }

  area.innerHTML=`
    <table>
      <tr><th>النسبة المئوية</th><th>الفصل</th></tr>
      ${rows}
    </table>
  `;
}
</script>

</body>
</html>
