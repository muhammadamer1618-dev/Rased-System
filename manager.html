<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مدير الإشراف - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#eef2f7;
  margin:0;
}
.header{
  background:#1976d2;
  color:#fff;
  text-align:center;
  padding:15px;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
}
.header h1{ margin:0; font-size:26px; font-weight:bold }
.header h2{ margin:5px 0 0; font-size:18px; color:#ffeb3b }

.container{
  max-width:1200px;
  margin:25px auto;
  padding:10px;
}
.box{
  background:#fff;
  border-radius:14px;
  padding:20px;
  margin-bottom:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.12);
}

h3{
  margin-top:0;
  color:#1976d2;
  font-size:20px;
  font-weight:bold;
  border-right:4px solid #1976d2;
  padding-right:8px;
}

.label-title{
  font-weight:bold;
  font-size:15px;
  margin-bottom:4px;
  color:#444;
}

.info-row{ display:flex; gap:15px; flex-wrap:wrap }
.info-item{
  flex:1;
  background:#fff;
  padding:12px;
  border-radius:10px;
  border:1px solid #c7d6f5;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}
.info-item span{ font-weight:bold; color:#1976d2 }

button{
  padding:8px 15px;
  border:none;
  border-radius:8px;
  font-size:14px;
  cursor:pointer;
  font-weight:bold;
}
.btn-primary{ background:#1976d2; color:#fff }
.btn-secondary{ background:#757575; color:#fff }
.btn-small{ padding:5px 10px; font-size:13px }

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-size:14px;
}
th,td{
  border:1px solid #ccc;
  text-align:center;
  padding:6px;
}
th{
  background:#1976d2;
  color:#fff;
  font-size:15px;
}
tr:nth-child(even){ background:#f9f9f9 }

select{
  padding:7px;
  border-radius:6px;
  border:1px solid #999;
  font-size:15px;
  width:100%;
  margin-top:6px;
}
</style>
</head>

<body>

<div class="header">
  <h1>نظام راصد</h1>
  <h2>مدير الإشراف</h2>
</div>

<div class="container">

  <!-- DASHBOARD -->
  <div class="box">
    <h3>لوحة التحكم</h3>

    <div class="info-row">
      <div class="info-item">
        <div class="label-title">إجمالي المشرفين</div>
        <span id="count_supervisors">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">إجمالي المعلمين</div>
        <span id="count_teachers">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">إجمالي الطلاب</div>
        <span id="count_students">—</span>
      </div>
    </div>
  </div>

  <!-- MANAGER INFO -->
  <div class="box">
    <h3>بيانات مدير الإشراف</h3>

    <div class="info-row">
      <div class="info-item">
        <div class="label-title">الاسم</div>
        <span id="m_name">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">اسم المستخدم</div>
        <span id="m_email">—</span>
      </div>
    </div>
  </div>

  <!-- SUPERVISORS -->
  <div class="box">
    <h3>المشرفون</h3>

    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>اسم المستخدم</th>
          <th>عدد المعلمين</th>
          <th>عرض المعلمين</th>
        </tr>
      </thead>
      <tbody id="supervisors_body"></tbody>
    </table>
  </div>

  <!-- TEACHERS -->
  <div class="box">
    <h3>المعلمون التابعون للمشرف المختار</h3>

    <div class="info-item" style="max-width:350px">
      <div class="label-title">المشرف المحدد</div>
      <span id="sel_supervisor">—</span>
    </div>

    <table id="teachers_table" style="display:none">
      <thead>
        <tr>
          <th>اسم المعلم</th>
          <th>اسم المستخدم</th>
          <th>عدد الفصول</th>
          <th>اختيار المادة</th>
        </tr>
      </thead>
      <tbody id="teachers_body"></tbody>
    </table>
  </div>

  <!-- STUDENTS -->
  <div class="box">
    <h3>طلاب الفصل والمادة</h3>

    <div class="info-item" style="max-width:350px">
      <div class="label-title">الفصل والمادة</div>
      <span id="class_info">—</span>
    </div>

    <table id="students_table" style="display:none">
      <thead>
        <tr>
          <th>الكود</th>
          <th>اسم الطالب</th>
          <th>الدرجة</th>
          <th>الدرجة النهائية</th>
          <th>التقدير</th>
        </tr>
      </thead>
      <tbody id="students_body"></tbody>
    </table>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">تسجيل الخروج</button>
  </div>

</div>

<script>
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* ===== GUARD ===== */
function guard(){
  let r=localStorage.getItem("currentUserRole");
  if(r!=="manager"){
    alert("هذه الصفحة لمدير الإشراف فقط");
    location="index.html";
  }
}
guard();

/* ===== LOAD MANAGER FROM FIRESTORE ===== */
async function loadManager(){
  let email=localStorage.getItem("currentUserEmail");
  document.getElementById("m_email").innerText=email;

  let doc=await db.collection("users").doc(email).get();
  if(doc.exists){
    document.getElementById("m_name").innerText = doc.data().name;
  } else {
    document.getElementById("m_name").innerText = "—";
  }
}
loadManager();

/* ===== DASHBOARD ===== */
async function loadDashboard(){
  let s=await db.collection("supervisors").get();
  document.getElementById("count_supervisors").innerText=s.size;

  let t=await db.collection("teachers").get();
  document.getElementById("count_teachers").innerText=t.size;

  let st=await db.collection("students").get();
  document.getElementById("count_students").innerText=st.size;
}
loadDashboard();

/* ===== LOAD SUPERVISORS ===== */
async function loadSupervisors(){
  let snap=await db.collection("supervisors").get();
  let tbody=document.getElementById("supervisors_body");
  tbody.innerHTML="";

  snap.forEach(doc=>{
    let s=doc.data();
    let count=(s.teachers||[]).length;

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.email}</td>
      <td>${count}</td>
      <td>
        <button class="btn-primary btn-small"
          onclick="viewSupervisor('${s.email}','${s.name}')">عرض</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
loadSupervisors();

/* ===== SHOW TEACHERS ===== */
async function viewSupervisor(email,name){
  document.getElementById("sel_supervisor").innerText=
    name+" ("+email+")";

  let d=await db.collection("supervisors").doc(email).get();
  let s=d.data();

  let tbody=document.getElementById("teachers_body");
  tbody.innerHTML="";
  document.getElementById("teachers_table").style.display="table";

  for(let tEmail of s.teachers){
    let tDoc=await db.collection("teachers").doc(tEmail).get();
    if(!tDoc.exists)continue;

    let t=tDoc.data();
    let assigns=t.assignments||[];
    let opts="";

    assigns.forEach((a,i)=>{
      opts+=`<option value="${t.email}|${i}">
        ${a.grade} - ${a.section} - ${a.subject}
      </option>`;
    });

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${t.name}</td>
      <td>${t.email}</td>
      <td>${assigns.length}</td>
      <td>
        <select onchange="selectClass(this.value)">
          <option value="">اختر مادة</option>
          ${opts}
        </select>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

/* ===== SHOW STUDENTS ===== */
function selectClass(value){
  if(!value)return;

  let [email,idx]=value.split("|");
  idx=parseInt(idx);

  loadClassData(email,idx);
}

async function loadClassData(email,idx){
  let tDoc=await db.collection("teachers").doc(email).get();
  let t=tDoc.data();

  let a=t.assignments[idx];
  document.getElementById("class_info").innerText=
    `${a.grade} - ${a.section} - ${a.subject}`;

  let tbody=document.getElementById("students_body");
  tbody.innerHTML="";
  document.getElementById("students_table").style.display="table";

  let q=db.collection("students")
    .where("grade","==",a.grade)
    .where("section","==",a.section);
  let snap=await q.get();

  let list=[];
  snap.forEach(d=>list.push(d.data()));

  list.sort((x,y)=>x.name.localeCompare(y.name,"ar"));

  list.forEach(st=>{
    let sub=st.subjects && st.subjects[a.subject];
    let m=sub?sub.mark:0;
    let f=sub?sub.fullMark:0;
    let r=sub?sub.rating:"—";

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${st.code}</td>
      <td>${st.name}</td>
      <td>${m}</td>
      <td>${f}</td>
      <td>${r}</td>
    `;
    tbody.appendChild(tr);
  });
}

</script>

</body>
</html>
