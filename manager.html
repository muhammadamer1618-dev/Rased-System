<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة مدير الإشراف - مدارس الفلاح الأهلية</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Calibri;
  background: #eef2f7;
  margin: 0;
}

.header {
  background: #1976d2;
  color: #fff;
  text-align: center;
  padding: 18px;
  font-size: 26px;
  font-weight: bold;
}

.container {
  max-width: 1150px;
  margin: 25px auto;
  padding: 10px;
}

.box {
  background: #fff;
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

h3 {
  margin: 0 0 15px 0;
  color: #1976d2;
  padding-right: 8px;
  border-right: 4px solid #1976d2;
}

.info-row { display: flex; gap: 15px; flex-wrap: wrap; }

.info-item {
  flex: 1;
  background: #fafcff;
  border: 1px solid #d5def7;
  border-radius: 10px;
  padding: 12px;
  min-width: 200px;
}

.label-title {
  font-size: 14px;
  font-weight: bold;
  color: #444;
  margin-bottom: 4px;
}

span { font-weight: bold; color: #1976d2; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 15px;
}

th, td {
  border: 1px solid #ccc;
  padding: 7px;
  text-align: center;
}

th {
  background: #1976d2;
  color: #fff;
}

.logout-btn {
  background: #c62828;
  color: #fff;
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="header">لوحة مدير الإشراف</div>

<div class="container">

  <!-- احصائيات -->
  <div class="box">
    <h3>لوحة التحكم</h3>

    <div class="info-row">

      <div class="info-item">
        <div class="label-title">إجمالي الطلاب</div>
        <span id="total_students">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">إجمالي المعلمين</div>
        <span id="total_teachers">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">إجمالي المشرفين</div>
        <span id="total_supervisors">—</span>
      </div>

    </div>
  </div>

  <!-- بيانات مدير الإشراف -->
  <div class="box">
    <h3>بيانات مدير الإشراف</h3>

    <div class="info-row">
      <div class="info-item">
        <div class="label-title">الاسم</div>
        <span id="manager_name">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">اسم المستخدم</div>
        <span id="manager_email">—</span>
      </div>
    </div>
  </div>

  <!-- جدول المشرفين -->
  <div class="box">
    <h3>المشرفون</h3>

    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>اسم المستخدم</th>
          <th>عدد المعلمين</th>
        </tr>
      </thead>
      <tbody id="supervisors_body"></tbody>
    </table>
  </div>

  <!-- خروج -->
  <div class="box" style="text-align:center">
    <button class="logout-btn" onclick="logout()">تسجيل الخروج</button>
  </div>

</div>

<script>
/* Firebase Config */
var firebaseConfig = {
  apiKey: "AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain: "results2026-7c0dd.firebaseapp.com",
  projectId: "results2026-7c0dd",
  storageBucket: "results2026-7c0dd.firebasestorage.app",
  messagingSenderId: "241421115694",
  appId: "1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.firestore();

/* حماية الصفحة */
function guard() {
  let role = localStorage.getItem("currentUserRole") || "";
  if (role !== "manager") {
    alert("هذه الصفحة مخصصة لمدير الإشراف فقط");
    location = "index.html";
  }
}

guard();

/* تحميل بيانات المدير */
function loadManager() {
  let email = localStorage.getItem("currentUserEmail") || "";
  document.getElementById("manager_email").innerText = email;

  db.collection("managers").doc(email).get().then(doc => {
    if (doc.exists) {
      document.getElementById("manager_name").innerText = doc.data().name || "—";
    }
  });
}

/* تحميل الإحصائيات */
async function loadStats() {
  let students = await db.collection("students").get();
  let teachers = await db.collection("teachers").get();
  let supervisors = await db.collection("supervisors").get();

  document.getElementById("total_students").innerText = students.size;
  document.getElementById("total_teachers").innerText = teachers.size;
  document.getElementById("total_supervisors").innerText = supervisors.size;

  loadSupervisorsTable(supervisors);
}

/* جدول المشرفين */
function loadSupervisorsTable(snap) {
  let body = document.getElementById("supervisors_body");
  body.innerHTML = "";

  snap.forEach(doc => {
    let d = doc.data();
    let count = (d.teachers || []).length;

    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.name || "—"}</td>
      <td>${d.email || doc.id}</td>
      <td>${count}</td>
    `;
    body.appendChild(tr);
  });
}

/* تسجيل خروج */
function logout() {
  localStorage.clear();
  location = "index.html";
}

/* تشغيل */
loadManager();
loadStats();
</script>

</body>
</html>
