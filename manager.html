<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مدير الإشراف - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">
<button class="btn-secondary" onclick="location='change_password.html'">
  تغيير كلمة المرور
</button>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>

body{
  font-family:Calibri;
  background:#f4f4f4;
  margin:0;
}

.header{
  background:#1976d2;
  color:#fff;
  text-align:center;
  padding:15px;
}

.header h1{
  margin:0;
  font-size:26px;
  letter-spacing:1px;
}

.header h2{
  margin:5px 0 0;
  font-size:20px;
  font-weight:bold;
  color:#ffeb3b;
}

.container{
  max-width:1100px;
  margin:20px auto;
  padding:10px;
}

.box{
  background:#fff;
  border-radius:12px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 0 12px rgba(0,0,0,0.12);
}

h3{
  margin-top:0;
  color:#1976d2;
  font-size:20px;
  font-weight:bold;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:15px;
}

th,td{
  border:1px solid #ccc;
  text-align:center;
  padding:7px;
}

th{
  background:#1976d2;
  color:#fff;
  font-size:15px;
}

tr:nth-child(even){
  background:#f9f9f9;
}

.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:10px;
  background:#e3f2fd;
  color:#0d47a1;
  font-size:15px;
  margin-right:6px;
}

.btn-secondary{
  background:#757575;
  color:#fff;
  padding:8px 17px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:15px;
  font-weight:bold;
}

select{
  padding:8px;
  width:100%;
  border-radius:6px;
  border:1px solid #888;
  margin-top:5px;
}

.option-btn{
  background:#1976d2;
  color:#fff;
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  font-weight:bold;
}

</style>
</head>
<body>

<div class="header">
  <h1>نظام راصد</h1>
  <h2>مدير الإشراف</h2>
</div>

<div class="container">

  <!-- بيانات المستخدم -->
  <div class="box" style="padding:20px">

  <h3 style="font-size:22px;color:#0d47a1;margin-bottom:15px;text-align:center;">
    بيانات مدير الإشراف
  </h3>

  <table style="width:100%;border-collapse:collapse;font-size:16px">
    <tr>
      <th style="background:#1976d2;color:white;padding:10px;font-size:17px;">الاسم</th>
      <th style="background:#1976d2;color:white;padding:10px;font-size:17px;">اسم المستخدم</th>
    </tr>

    <tr>
      <td style="padding:10px;font-weight:bold;">
        <span id="m_name">—</span>
        <div style="font-size:14px;color:#555;margin-top:5px;font-weight:normal;">
          أحمد سمير عباس
        </div>
      </td>

      <td style="padding:10px;font-weight:bold;">
        <span id="m_email">—</span>
      </td>
    </tr>
  </table>

</div>

  <!-- جميع المشرفين -->
  <div class="box">
    <h3>المشرفون في النظام</h3>

    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>اسم المستخدم</th>
          <th>عدد المعلمين</th>
          <th>عرض</th>
        </tr>
      </thead>
      <tbody id="supervisors_body"></tbody>
    </table>
  </div>

  <!-- تفاصيل المشرف -->
  <div class="box">
    <h3>تفاصيل المشرف</h3>

    <div id="sup_info" class="badge">—</div>

    <table id="teachers_table" style="display:none">
      <thead>
        <tr>
          <th>المعلم</th>
          <th>اسم المستخدم</th>
          <th>الفصول</th>
          <th>عرض الفصول</th>
        </tr>
      </thead>
      <tbody id="teachers_body"></tbody>
    </table>
  </div>

  <!-- طلاب الفصل -->
  <div class="box">
    <h3>طلاب الفصل</h3>

    <div id="class_info" class="badge">—</div>

    <table id="students_table" style="display:none">
      <thead>
        <tr>
          <th>الكود</th>
          <th>الاسم</th>
          <th>الصف</th>
          <th>الشعبة</th>
          <th>الدرجات</th>
        </tr>
      </thead>
      <tbody id="students_body"></tbody>
    </table>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">تسجيل الخروج</button>
  </div>

</div>


<script>
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();


/* حماية الصفحة */
function guard(){
  let r=localStorage.getItem("currentUserRole");
  if(r!=="manager"){
    alert("هذه الصفحة لمدير الإشراف فقط");
    location="index.html";
  }
}
guard();

/* تحميل بيانات المدير */
document.getElementById("m_email").innerText =
  localStorage.getItem("currentUserEmail")||"—";

document.getElementById("m_name").innerText =
  localStorage.getItem("currentUserName")||"—";


/* تحميل المشرفين */
async function loadSupervisors(){
  let snap=await db.collection("supervisors").get();
  let tbody=document.getElementById("supervisors_body");
  tbody.innerHTML="";

  snap.forEach(doc=>{
    let s=doc.data();
    let count=(s.teachers && s.teachers.length)? s.teachers.length:0;

    let tr=document.createElement("tr");
    tr.innerHTML=
      "<td>"+s.name+"</td>"+
      "<td>"+s.email+"</td>"+
      "<td>"+count+"</td>"+
      "<td><button class='option-btn' onclick='viewSupervisor(\""+s.email+"\")'>عرض</button></td>";
    tbody.appendChild(tr);
  });
}
loadSupervisors();


/* عرض المعلمين */
async function viewSupervisor(email){
  let d=await db.collection("supervisors").doc(email).get();
  if(!d.exists)return;

  let s=d.data();

  document.getElementById("sup_info").innerText =
    "المشرف: "+s.name+" ("+s.email+")";

  let tbody=document.getElementById("teachers_body");
  tbody.innerHTML="";
  document.getElementById("teachers_table").style.display="table";

  if(!s.teachers || !s.teachers.length){
    tbody.innerHTML="<tr><td colspan='4'>لا يوجد معلمين</td></tr>";
    return;
  }

  for(let tEmail of s.teachers){
    let tDoc=await db.collection("teachers").doc(tEmail).get();
    if(tDoc.exists){
      let t=tDoc.data();
      let ass=(t.assignments||[])
        .map(a=>a.grade+"-"+a.section+"-"+a.subject).join(" | ");

      let tr=document.createElement("tr");
      tr.innerHTML=
        "<td>"+t.name+"</td>"+
        "<td>"+t.email+"</td>"+
        "<td>"+(ass||"—")+"</td>"+
        "<td><button class='option-btn' onclick='viewTeacher(\""+t.email+"\")'>عرض</button></td>";
      tbody.appendChild(tr);
    }
  }
}


/* عرض الطلاب */
async function viewTeacher(email){
  let tDoc=await db.collection("teachers").doc(email).get();
  if(!tDoc.exists)return;

  let t=tDoc.data();
  if(!t.assignments || !t.assignments.length){
    alert("لا يوجد فصول لهذا المعلم");
    return;
  }

  /* قائمة منسدلة بدل prompt */
  let selector=document.createElement("div");
  selector.innerHTML = `<select id='classSelect' style='padding:8px;font-size:15px;width:250px;margin:10px 0'>
    ${t.assignments.map((a,i)=>`<option value='${i}'>${a.grade} - ${a.section} - ${a.subject}</option>`).join("")}
  </select>
  <button class='option-btn' onclick='chooseClass(${JSON.stringify(email)})'>اختيار</button>`;

  document.getElementById("sup_info").appendChild(selector);
}

/* استكمال اختيار الفصل */
async function chooseClass(email){
  let tDoc=await db.collection("teachers").doc(email).get();
  let t=tDoc.data();
  let idx=document.getElementById("classSelect").value;
  loadStudents(t.assignments[idx], t);
}


async function loadStudents(assign, teacher){
  document.getElementById("class_info").innerText =
    "المعلم: "+teacher.name+" | "+assign.grade+"-"+assign.section+"-"+assign.subject;

  let tbody=document.getElementById("students_body");
  tbody.innerHTML="";
  document.getElementById("students_table").style.display="table";

  let q=db.collection("students")
    .where("grade","==",assign.grade)
    .where("section","==",assign.section);

  let snap=await q.get();
  let students=[];
  snap.forEach(doc=>students.push(doc.data()));
  students.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));

  if(!students.length){
    tbody.innerHTML="<tr><td colspan='5'>لا يوجد طلاب</td></tr>";
    return;
  }

  students.forEach(st=>{
    let subs=st.subjects||{};
    let txt="";
    Object.keys(subs).forEach(x=>{
      txt+=x+": "+subs[x].mark+"/"+subs[x].fullMark+" | ";
    });
    if(!txt)txt="—";

    let tr=document.createElement("tr");
    tr.innerHTML=
      "<td>"+st.code+"</td>"+
      "<td>"+st.name+"</td>"+
      "<td>"+st.grade+"</td>"+
      "<td>"+st.section+"</td>"+
      "<td>"+txt+"</td>";
    tbody.appendChild(tr);
  });
}

</script>

</body>
</html>
