<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø±Ø§Ù - Ù†Ø¸Ø§Ù… Ø±Ø§ØµØ¯</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#eef2f7;
  margin:0;
}

/* HEADER */
.header{
  background:#1976d2;
  color:#fff;
  text-align:center;
  padding:15px;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
}
.header h1{ margin:0; font-size:26px; font-weight:bold }
.header h2{ margin:5px 0 0; font-size:18px; color:#ffeb3b }

/* MAIN */
.container{
  max-width:1200px;
  margin:25px auto;
  padding:10px;
}

.box{
  background:#fff;
  border-radius:14px;
  padding:20px;
  margin-bottom:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.12);
}

h3{
  margin-top:0;
  color:#1976d2;
  font-size:20px;
  font-weight:bold;
  border-right:4px solid #1976d2;
  padding-right:8px;
}

.label-title{
  font-weight:bold;
  font-size:15px;
  margin-bottom:4px;
  color:#444;
}

.info-row{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
}

.info-item{
  flex:1;
  background:#fff;
  padding:12px;
  border-radius:10px;
  border:1px solid #c7d6f5;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}
.info-item span{
  font-weight:bold;
  color:#1976d2;
}

/* BUTTONS */
button{
  padding:8px 15px;
  border:none;
  border-radius:8px;
  font-size:14px;
  cursor:pointer;
  font-weight:bold;
}
.btn-primary{background:#1976d2;color:#fff}
.btn-secondary{background:#757575;color:#fff}
.btn-small{padding:5px 10px;font-size:13px}

/* TABLES */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  font-size:14px;
}
th,td{
  border:1px solid #ccc;
  text-align:center;
  padding:6px;
}
th{
  background:#1976d2;
  color:#fff;
  font-size:15px;
}
tr:nth-child(even){background:#f9f9f9}

/* SELECT */
select{
  padding:7px;
  border-radius:6px;
  border:1px solid #999;
  font-size:15px;
  width:100%;
  margin-top:6px;
}
</style>
</head>

<body>

<div class="header">
  <h1>Ù†Ø¸Ø§Ù… Ø±Ø§ØµØ¯</h1>
  <h2>Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø±Ø§Ù</h2>
</div>

<div class="container">

  <!-- DASHBOARD -->
  <div class="box">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>

    <div class="info-row">
      <div class="info-item">
        <div class="label-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</div>
        <span id="count_supervisors">â€”</span>
      </div>

      <div class="info-item">
        <div class="label-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
        <span id="count_teachers">â€”</span>
      </div>

      <div class="info-item">
        <div class="label-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        <span id="count_students">â€”</span>
      </div>
    </div>

    <button class="btn-primary" style="margin-top:15px" onclick="location='analysis.html'">
      ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    </button>
  </div>

  <!-- MANAGER DATA -->
  <div class="box">
    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø±Ø§Ù</h3>

    <div class="info-row">

      <div class="info-item">
        <div class="label-title">Ø§Ù„Ø§Ø³Ù…</div>
        <span id="m_name">â€”</span>
      </div>

      <div class="info-item">
        <div class="label-title">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        <span id="m_email">â€”</span>
      </div>

    </div>
  </div>

  <!-- SUPERVISORS -->
  <div class="box">
    <h3>Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ†</h3>

    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</th>
          <th>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</th>
        </tr>
      </thead>
      <tbody id="supervisors_body"></tbody>
    </table>
  </div>

  <!-- TEACHERS UNDER SUPERVISOR -->
  <div class="box">
    <h3>Ø§Ù„Ù…Ø¹Ù„Ù…ÙˆÙ† Ø§Ù„ØªØ§Ø¨Ø¹ÙˆÙ† Ù„Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø®ØªØ§Ø±</h3>

    <div class="info-item" style="max-width:350px">
      <div class="label-title">Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</div>
      <span id="sel_supervisor">â€”</span>
    </div>

    <table id="teachers_table" style="display:none">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„</th>
          <th>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©</th>
        </tr>
      </thead>
      <tbody id="teachers_body"></tbody>
    </table>
  </div>

  <!-- STUDENTS -->
  <div class="box">
    <h3>Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ù…Ø§Ø¯Ø©</h3>

    <div class="info-item" style="max-width:350px">
      <div class="label-title">Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ù…Ø§Ø¯Ø©</div>
      <span id="class_info">â€”</span>
    </div>

    <table id="students_table" style="display:none">
      <thead>
        <tr>
          <th>Ø§Ù„ÙƒÙˆØ¯</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
          <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
          <th>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th>
          <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
        </tr>
      </thead>
      <tbody id="students_body"></tbody>
    </table>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

</div>

<script>
/* Firebase */
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* GUARD */
function guard(){
  if(localStorage.getItem("currentUserRole")!=="manager"){
    alert("Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø®Ø§ØµØ© Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø´Ø±Ø§Ù ÙÙ‚Ø·");
    location="index.html";
  }
}
guard();

/* LOAD MANAGER DATA */
document.getElementById("m_email").innerText=
  localStorage.getItem("currentUserEmail")||"â€”";
document.getElementById("m_name").innerText=
  localStorage.getItem("currentUserName")||"â€”";

/* DASHBOARD */
async function loadDashboard(){
  let s=await db.collection("supervisors").get();
  document.getElementById("count_supervisors").innerText=s.size;

  let t=await db.collection("teachers").get();
  document.getElementById("count_teachers").innerText=t.size;

  let st=await db.collection("students").get();
  document.getElementById("count_students").innerText=st.size;
}
loadDashboard();

/* LOAD SUPERVISORS */
async function loadSupervisors(){
  let snap=await db.collection("supervisors").get();
  let body=document.getElementById("supervisors_body");
  body.innerHTML="";

  snap.forEach(doc=>{
    let s=doc.data();
    let tr=document.createElement("tr");

    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.email}</td>
      <td>${(s.teachers||[]).length}</td>
      <td>
        <button class="btn-primary btn-small"
         onclick="viewSupervisor('${s.email}','${s.name}')">
         Ø¹Ø±Ø¶
        </button>
      </td>
    `;

    body.appendChild(tr);
  });
}
loadSupervisors();

/* SHOW TEACHERS OF SUPERVISOR */
async function viewSupervisor(email,name){
  document.getElementById("sel_supervisor").innerText=name+" ("+email+")";

  let doc=await db.collection("supervisors").doc(email).get();
  let data=doc.data();

  let body=document.getElementById("teachers_body");
  body.innerHTML="";
  document.getElementById("teachers_table").style.display="table";

  for(let tEmail of data.teachers){
    let tDoc=await db.collection("teachers").doc(tEmail).get();
    if(!tDoc.exists)continue;

    let t=tDoc.data();
    let opts="";

    (t.assignments||[]).forEach((a,i)=>{
      opts+=`
      <option value="${t.email}|${i}">
        ${a.grade} - ${a.section} - ${a.subject}
      </option>`;
    });

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${t.name}</td>
      <td>${t.email}</td>
      <td>${(t.assignments||[]).length}</td>
      <td>
        <select onchange="selectClass(this.value)">
          <option value="">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø©</option>
          ${opts}
        </select>
      </td>
    `;
    body.appendChild(tr);
  }
}

/* SELECT CLASS */
function selectClass(v){
  if(!v)return;
  let [email,i]=v.split("|");
  loadClass(email,parseInt(i));
}

/* LOAD STUDENTS */
async function loadClass(email,i){
  let tDoc=await db.collection("teachers").doc(email).get();
  let t=tDoc.data();
  let a=t.assignments[i];

  document.getElementById("class_info").innerText=
    `${a.grade} - ${a.section} - ${a.subject}`;

  let q=db.collection("students")
    .where("grade","==",a.grade)
    .where("section","==",a.section);

  let snap=await q.get();
  let list=[];
  snap.forEach(d=>list.push(d.data()));

  list.sort((x,y)=>x.name.localeCompare(y.name,"ar"));

  let body=document.getElementById("students_body");
  body.innerHTML="";
  document.getElementById("students_table").style.display="table";

  list.forEach(st=>{
    let sub=st.subjects && st.subjects[a.subject];
    let m=sub?sub.mark:0;
    let f=sub?sub.fullMark:0;
    let r=sub?sub.rating:"â€”";

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${st.code}</td>
      <td>${st.name}</td>
      <td>${m}</td>
      <td>${f}</td>
      <td>${r}</td>
    `;
    body.appendChild(tr);
  });
}
</script>

</body>
</html>
