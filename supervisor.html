<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">
<button class="btn-secondary" onclick="location='change_password.html'">
  تغيير كلمة المرور
</button>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Calibri;background:#eef2f7;margin:0}
.header{
  background:#1976d2;color:#fff;text-align:center;padding:15px;
  box-shadow:0 2px 5px rgba(0,0,0,0.2)
}
.header h1{margin:0;font-size:26px;font-weight:bold}
.header h2{margin:5px 0 0;font-size:18px;color:#ffeb3b}

.container{max-width:1100px;margin:25px auto;padding:10px}

.box{
  background:#fff;border-radius:14px;padding:20px;margin-bottom:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.12)
}

h3{
  margin-top:0;color:#1976d2;font-size:20px;font-weight:bold;
  border-right:4px solid #1976d2;padding-right:8px
}

.label-title{
  font-weight:bold;font-size:15px;margin-bottom:4px;color:#444
}

.info-row{display:flex;gap:15px;flex-wrap:wrap}
.info-item{
  flex:1;
  background:#fff;
  padding:12px;
  border-radius:10px;
  border:1px solid #c7d6f5;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}
.info-item span{font-weight:bold;color:#1976d2}

button{
  padding:8px 15px;border:none;border-radius:8px;font-size:14px;
  cursor:pointer;font-weight:bold
}
.btn-primary{background:#1976d2;color:#fff}
.btn-secondary{background:#757575;color:#fff}

table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
th,td{border:1px solid #ccc;text-align:center;padding:6px}
th{
  background:#1976d2;color:#fff;font-size:15px
}
tr:nth-child(even){background:#f9f9f9}

select{
  padding:7px;border-radius:6px;border:1px solid #999;font-size:15px;
  width:100%;margin-top:6px
}

</style>
</head>
<body>

<div class="header">
  <h1>مدارس الفلاح الأهلية</h1>
  <h2>لوحة المشرف</h2>
</div>

<div class="container">

  <!-- بيانات المشرف -->
  <div class="box">
    <h3>بيانات المشرف</h3>

    <div class="info-row">
      <div class="info-item">
        <div class="label-title">اسم المشرف</div>
        <span id="sup_name">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">اسم المستخدم</div>
        <span id="sup_email">—</span>
      </div>

      <div class="info-item">
        <div class="label-title">عدد المعلمين</div>
        <span id="sup_t_count">—</span>
      </div>
    </div>

    <button class="btn-secondary" onclick="window.print()">طباعة / PDF</button>
  </div>


  <!-- جدول المعلمين -->
  <div class="box">
    <h3>المعلمون التابعون للمشرف</h3>
    <table>
      <thead>
        <tr>
          <th>المعلم</th>
          <th>اسم المستخدم</th>
          <th>عدد الفصول</th>
          <th>اختيار فصل ومادة</th>
        </tr>
      </thead>
      <tbody id="sup_teachers_body"></tbody>
    </table>
  </div>


  <!-- عرض الطلاب -->
  <div class="box">
    <h3>طلاب الفصل المحدد</h3>

    <div class="info-item" style="max-width:350px">
      <div class="label-title">الفصل والمادة</div>
      <span id="currentClassInfo">—</span>
    </div>

    <table id="sup_students_table" style="display:none">
      <thead>
        <tr>
          <th>كود</th>
          <th>اسم الطالب</th>
          <th>الصف</th>
          <th>الشعبة</th>
          <th>الدرجة</th>
        </tr>
      </thead>
      <tbody id="sup_students_body"></tbody>
    </table>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">تسجيل الخروج</button>
  </div>

</div>


<script>
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

let currentEmail="";
let teachersMap={};

function ensureSupervisorGuard(){
  let r=localStorage.getItem("currentUserRole");
  if(r!=="supervisor"){
    alert("هذه الصفحة للمشرفين فقط");
    location="index.html";
  }
  currentEmail=localStorage.getItem("currentUserEmail");
}

async function loadSupervisor(){
  let doc=await db.collection("supervisors").doc(currentEmail).get();
  let data=doc.data()||{teachers:[]};

  document.getElementById("sup_name").innerText=data.name;
  document.getElementById("sup_email").innerText=data.email;
  document.getElementById("sup_t_count").innerText=data.teachers.length;

  loadSupervisorTeachers(data.teachers);
}

async function loadSupervisorTeachers(list){
  let body=document.getElementById("sup_teachers_body");
  body.innerHTML="";

  for(let email of list){
    let tDoc=await db.collection("teachers").doc(email).get();
    if(!tDoc.exists) continue;

    let t=tDoc.data();
    teachersMap[email]=t;

    let options="";
    (t.assignments||[]).forEach((a,i)=>{
      options+=`
        <option value="${email}|${i}">
          ${a.grade} - ${a.section} - ${a.subject}
        </option>`;
    });

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${t.name}</td>
      <td>${t.email}</td>
      <td>${(t.assignments||[]).length}</td>
      <td>
        <select onchange="selectClass(this.value)">
          <option value="">اختر فصلًا ومادة</option>
          ${options}
        </select>
      </td>`;
    body.appendChild(tr);
  }
}

function selectClass(val){
  if(!val) return;

  let [email, idx]=val.split("|");
  idx=parseInt(idx);

  let t=teachersMap[email];
  let assign=t.assignments[idx];

  loadStudents(assign);
}

async function loadStudents(assign){
  document.getElementById("currentClassInfo").innerText=
    `${assign.grade} - ${assign.section} - ${assign.subject}`;

  let table=document.getElementById("sup_students_table");
  let body=document.getElementById("sup_students_body");
  body.innerHTML="";
  table.style.display="none";

  let q=db.collection("students")
    .where("grade","==",assign.grade)
    .where("section","==",assign.section);

  let snap=await q.get();
  let stds=[];
  snap.forEach(doc=>stds.push(doc.data()));

  stds.sort((a,b)=>a.name.localeCompare(b.name,"ar"));

  stds.forEach(s=>{
    let mark=s.subjects && s.subjects[assign.subject]
      ? s.subjects[assign.subject].mark || 0
      : 0;

    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${s.code}</td>
      <td>${s.name}</td>
      <td>${s.grade}</td>
      <td>${s.section}</td>
      <td>${mark}</td>`;
    body.appendChild(tr);
  });

  table.style.display="table";
}

ensureSupervisorGuard();
loadSupervisor();
</script>

</body>
</html>
