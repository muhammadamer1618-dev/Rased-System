<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف - مدارس الفلاح الأهلية</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">
<button class="btn-secondary" onclick="location='change_password.html'">
  تغيير كلمة المرور
</button>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Calibri;background:#f4f4f4;margin:0}
.header{background:#1976d2;color:#fff;text-align:center;padding:15px}
.header h1{margin:0;font-size:24px}
.header h2{margin:5px 0 0;font-size:18px;color:#ffeb3b}
.container{max-width:1100px;margin:20px auto;padding:10px}
.box{background:#fff;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 0 8px rgba(0,0,0,0.1)}
h3{margin-top:0;color:#1976d2}
label{display:block;margin-top:5px}
button{font-family:Calibri;font-size:14px;padding:6px;margin-top:4px;border-radius:6px;border:none;cursor:pointer;font-weight:bold}
.btn-primary{background:#1976d2;color:#fff}
.btn-secondary{background:#757575;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{border:1px solid #ccc;text-align:center;padding:5px}
th{background:#1976d2;color:#fff}
tr:nth-child(even){background:#f9f9f9}
.badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;background:#e3f2fd;color:#0d47a1}
</style>
</head>
<body>

<div class="header">
  <h1>مدارس الفلاح الأهلية</h1>
  <h2 id="sup_title">لوحة المشرف</h2>
</div>

<div class="container">

  <div class="box">
    <h3>بيانات المشرف</h3>
    <div>الاسم: <span id="sup_name" class="badge">—</span></div>
    <div>البريد: <span id="sup_email" class="badge">—</span></div>
    <div>عدد المعلمين: <span id="sup_t_count" class="badge">—</span></div>
    <button class="btn-secondary" style="margin-top:8px" onclick="window.print()">طباعة / PDF</button>
  </div>

  <div class="box">
    <h3>المعلمون التابعون للمشرف</h3>
    <table>
      <thead>
        <tr><th>المعلم</th><th>البريد</th><th>الفصول المسندة</th><th>عرض التفاصيل</th></tr>
      </thead>
      <tbody id="sup_teachers_body"></tbody>
    </table>
  </div>

  <div class="box">
    <h3>طلاب الفصل المختار</h3>
    <div id="currentClassInfo" class="badge">—</div>
    <table id="sup_students_table" style="display:none">
      <thead>
        <tr><th>الكود</th><th>الاسم</th><th>الصف</th><th>الشعبة</th><th>المواد والدرجات</th></tr>
      </thead>
      <tbody id="sup_students_body"></tbody>
    </table>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">تسجيل الخروج</button>
  </div>

</div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain: "results2026-7c0dd.firebaseapp.com",
  projectId: "results2026-7c0dd",
  storageBucket: "results2026-7c0dd.firebasestorage.app",
  messagingSenderId: "241421115694",
  appId: "1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

var currentEmail="";
var supervisorData=null;
var teachersMap={};

function ensureSupervisorGuard(){
  let r=localStorage.getItem("currentUserRole")||"";
  if(r!=="supervisor"){
    alert("هذه الصفحة للمشرفين فقط");
    location="index.html";
  }
  currentEmail=localStorage.getItem("currentUserEmail")||"";
}

async function loadSupervisor(){
  if(!currentEmail)return;
  let doc=await db.collection("supervisors").doc(currentEmail).get();
  if(!doc.exists){
    alert("بيانات المشرف غير موجودة");
    return;
  }
  supervisorData=doc.data()||{};
  document.getElementById("sup_name").innerText=supervisorData.name||"—";
  document.getElementById("sup_email").innerText=supervisorData.email||"—";

  let tEmails=supervisorData.teachers||[];
  document.getElementById("sup_t_count").innerText=tEmails.length.toString();

  await loadSupervisorTeachers(tEmails);
}

async function loadSupervisorTeachers(tEmails){
  let tbody=document.getElementById("sup_teachers_body");
  tbody.innerHTML="";
  if(!tEmails.length){
    tbody.innerHTML="<tr><td colspan='4'>لا يوجد معلمون مسندون</td></tr>";
    return;
  }

  teachersMap={};
  for(let email of tEmails){
    let doc=await db.collection("teachers").doc(email).get();
    if(doc.exists){
      teachersMap[email]=doc.data();
    }
  }

  let emailsSorted=Object.keys(teachersMap).sort((a,b)=>{
    return (teachersMap[a].name||"").localeCompare(teachersMap[b].name||"","ar");
  });

  emailsSorted.forEach(email=>{
    let t=teachersMap[email];
    let count=(t.assignments && t.assignments.length)? t.assignments.length : 0;
    let assText="";
    (t.assignments||[]).forEach(a=>{
      assText+=a.grade+"-"+a.section+"-"+a.subject+" | ";
    });
    if(!assText)assText="لا يوجد";

    let tr=document.createElement("tr");
    tr.innerHTML=
      "<td>"+(t.name||"")+"</td>"+
      "<td>"+(t.email||"")+"</td>"+
      "<td>"+assText+"</td>"+
      "<td><button class='btn-primary' onclick='chooseTeacher(\""+email+"\")'>عرض الفصول</button></td>";
    tbody.appendChild(tr);
  });
}

function chooseTeacher(email){
  let t=teachersMap[email];
  if(!t || !t.assignments || !t.assignments.length){
    alert("لا يوجد فصول مسندة لهذا المعلم");
    return;
  }

  let info="اختر فصل من الفصول: ";
  t.assignments.forEach((a,i)=>{
    info+="\n"+(i+1)+") "+a.grade+" - "+a.section+" - "+a.subject;
  });
  let num=prompt(info+"\nاكتب رقم الفصل المطلوب:");
  if(!num)return;
  let idx=parseInt(num)-1;
  if(isNaN(idx) || idx<0 || idx>=t.assignments.length){
    alert("رقم غير صحيح");
    return;
  }
  let a=t.assignments[idx];
  loadClassStudents(a, t);
}

async function loadClassStudents(assign, teacher){
  document.getElementById("currentClassInfo").innerText=
    "المعلم: "+(teacher.name||"")+" | "+assign.grade+" - "+assign.section+" - "+assign.subject;

  let table=document.getElementById("sup_students_table");
  let body=document.getElementById("sup_students_body");
  body.innerHTML="";
  table.style.display="none";

  let q=db.collection("students")
    .where("grade","==",assign.grade)
    .where("section","==",assign.section);

  let snap=await q.get();
  let students=[];
  snap.forEach(doc=>students.push(doc.data()));
  students.sort((a,b)=>(a.name||"").localeCompare(b.name||"","ar"));

  if(!students.length){
    body.innerHTML="<tr><td colspan='5'>لا يوجد طلاب لهذا الفصل</td></tr>";
    table.style.display="table";
    return;
  }

  students.forEach(st=>{
    let subjects=st.subjects||{};
    let subText="";
    Object.keys(subjects).forEach(k=>{
      let v=subjects[k];
      subText+=k+": "+(v.mark||0)+"/"+(v.fullMark||0)+" | ";
    });
    if(!subText)subText="لا توجد درجات مسجلة";

    let tr=document.createElement("tr");
    tr.innerHTML=
      "<td>"+(st.code||"")+"</td>"+
      "<td>"+(st.name||"")+"</td>"+
      "<td>"+(st.grade||"")+"</td>"+
      "<td>"+(st.section||"")+"</td>"+
      "<td>"+subText+"</td>";
    body.appendChild(tr);
  });

  table.style.display="table";
}

ensureSupervisorGuard();
loadSupervisor();
</script>

</body>
</html>
