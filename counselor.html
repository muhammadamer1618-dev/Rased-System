<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الموجّه الطلابي - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  margin:0;
  background:#eef2f7;
}

.header{
  background:#1976d2;
  color:white;
  text-align:center;
  padding:18px;
  font-size:22px;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,0.25);
}

.container{
  max-width:1200px;
  margin:25px auto;
  padding:10px;
}

.box{
  background:white;
  padding:18px;
  border-radius:12px;
  margin-bottom:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
}

h3{
  margin:0 0 12px 0;
  color:#1976d2;
  font-size:20px;
  border-right:4px solid #1976d2;
  padding-right:8px;
}

.info-row{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
}

.info-item{
  flex:1;
  background:#fff;
  padding:12px;
  border-radius:10px;
  border:1px solid #d3dcf8;
  text-align:center;
  font-size:16px;
  font-weight:bold;
  color:#1976d2;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th{
  background:#1976d2;
  color:white;
  font-size:15px;
}
tr:nth-child(even){
  background:#f9f9f9;
}

.btn-secondary{
  padding:10px 15px;
  background:#757575;
  color:white;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="header">الموجّه الطلابي - نظام راصد</div>

<div class="container">

  <!-- Dashboard -->
  <div class="box">
    <h3>الملخص العام</h3>
    <div class="info-row">
      <div class="info-item">الطلاب المتعثرين: <span id="count_low">—</span></div>
      <div class="info-item">طلاب درجات ناقصة: <span id="count_missing">—</span></div>
      <div class="info-item">إجمالي الطلاب: <span id="count_students">—</span></div>
    </div>
  </div>

  <!-- Low Students -->
  <div class="box">
    <h3>الطلاب المتعثرين دراسيًا</h3>
    <table>
      <thead>
        <tr>
          <th>اسم الطالب</th>
          <th>الصف</th>
          <th>الشعبة</th>
          <th>المادة</th>
          <th>الدرجة</th>
          <th>النهائية</th>
          <th>التقدير</th>
          <th>المعلم</th>
        </tr>
      </thead>
      <tbody id="low_body"></tbody>
    </table>
  </div>

  <!-- Missing Marks -->
  <div class="box">
    <h3>طلاب لديهم مواد بدون درجات</h3>
    <table>
      <thead>
        <tr>
          <th>اسم الطالب</th>
          <th>الصف</th>
          <th>الشعبة</th>
          <th>المواد الناقصة</th>
          <th>المعلم</th>
        </tr>
      </thead>
      <tbody id="missing_body"></tbody>
    </table>
  </div>

  <div class="box">
    <button class="btn-secondary" onclick="location='index.html'">
      تسجيل الخروج
    </button>
  </div>

</div>

<script>
var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* ================== تحميل المواد الرسمية لكل صف ================== */
var fullMarksByGrade = {};

async function loadOfficialSubjects(){
  let grades=[
    "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
    "1 متوسط","2 متوسط","3 متوسط",
    "1 ثانوي","2 ثانوي","3 ثانوي"
  ];

  for (let g of grades){
    let doc = await db.collection("settings").doc("subjects_"+g).get();
    fullMarksByGrade[g] = {};
    if(doc.exists){
      (doc.data().subjects||[]).forEach(s=>{
        fullMarksByGrade[g][s.name] = Math.round(s.fullMark);
      });
    }
  }
}

/* ================== تحميل بيانات الطلاب ================== */
async function loadAll(){
  await loadOfficialSubjects();

  let snap=await db.collection("students").get();
  document.getElementById("count_students").innerText=snap.size;

  let lowBody=document.getElementById("low_body");
  let missingBody=document.getElementById("missing_body");

  lowBody.innerHTML="";
  missingBody.innerHTML="";

  let lowCount=0, missingCount=0;

  snap.forEach(doc=>{
    let st=doc.data();
    let subs=st.subjects||{};
    let missingSubs=[];

    let gradeFullMarks = fullMarksByGrade[st.grade] || {};

    Object.keys(subs).forEach(sub=>{
      let recorded = subs[sub];
      let correctFull = gradeFullMarks[sub] || recorded.fullMark || 0;

      // معالجة الدرجات الخاطئة
      let mark = Number(recorded.mark || 0);
      let full = Number(correctFull);

      if(full === 0) return;

      let pct = (mark/full) * 100;

      if(pct < 60){
        lowCount++;
        lowBody.innerHTML+=`
          <tr>
            <td>${st.name}</td>
            <td>${st.grade}</td>
            <td>${st.section}</td>
            <td>${sub}</td>
            <td>${mark}</td>
            <td>${full}</td>
            <td>${recorded.rating||"—"}</td>
            <td>—</td>
          </tr>`;
      }
    });

    Object.keys(subs).forEach(sub=>{
      let m=subs[sub].mark;
      if(m === "" || m === null || m === undefined){
        missingSubs.push(sub);
      }
    });

    if(missingSubs.length){
      missingCount++;
      missingBody.innerHTML+=`
        <tr>
          <td>${st.name}</td>
          <td>${st.grade}</td>
          <td>${st.section}</td>
          <td>${missingSubs.join(" | ")}</td>
          <td>—</td>
        </tr>`;
    }

  });

  document.getElementById("count_low").innerText=lowCount;
  document.getElementById("count_missing").innerText=missingCount;
}

loadAll();
</script>

</body>
</html>
