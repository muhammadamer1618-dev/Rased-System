<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الموجّه الطلابي - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#eef2f7;
  margin:0;
}

.header{
  background:#1976d2;
  color:white;
  text-align:center;
  padding:18px;
  font-size:24px;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,0.25);
}

.container{
  max-width:1300px;
  margin:25px auto;
  padding:10px;
}

.box{
  background:white;
  padding:18px;
  border-radius:12px;
  margin-bottom:18px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
}

h3{
  margin:0 0 12px 0;
  color:#1976d2;
  font-size:20px;
  border-right:4px solid #1976d2;
  padding-right:8px;
}

/* Filters */
.filter-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:15px;
}
select{
  padding:8px;
  font-size:15px;
  border-radius:6px;
  border:1px solid #888;
  min-width:150px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:15px;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th{
  background:#1976d2;
  color:white;
}
tr:nth-child(even){
  background:#f9f9f9;
}

.low{background:#ffebee;}
.missing{background:#fff3cd;}

.btn{
  background:#1976d2;
  color:white;
  padding:10px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  margin-top:10px;
}

</style>
</head>
<body>

<div class="header">الموجّه الطلابي - نظام راصد</div>

<div class="container">

  <!-- Filters -->
  <div class="box">
    <h3>فلترة البيانات</h3>
    <div class="filter-row">
      <select id="filter_grade"></select>
      <select id="filter_section">
        <option value="">كل الشعب</option>
        <option>أ</option><option>ب</option><option>ج</option>
      </select>
      <select id="filter_rating">
        <option value="">كل التقديرات</option>
        <option value="excellent">ممتاز</option>
        <option value="verygood">جيد جدًا</option>
        <option value="good">جيد</option>
        <option value="weak">ضعيف</option>
        <option value="missing">درجات ناقصة</option>
      </select>
      <select id="filter_subject"></select>

      <button class="btn" onclick="loadAll()">تطبيق الفلتر</button>
    </div>
  </div>

  <!-- Students Table -->
  <div class="box">
    <h3>قائمة الطلاب</h3>
    <table>
      <thead>
        <tr>
          <th>اسم الطالب</th>
          <th>الصف</th>
          <th>الشعبة</th>
          <th>المادة</th>
          <th>الدرجة</th>
          <th>النهائية</th>
          <th>النسبة</th>
          <th>التقدير</th>
        </tr>
      </thead>
      <tbody id="students_body"></tbody>
    </table>
  </div>

  <div class="box">
    <button class="btn" onclick="location='index.html'">تسجيل الخروج</button>
  </div>

</div>

<script>

var firebaseConfig={
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

var gradesList=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

function fillGrades(){
  let g=document.getElementById("filter_grade");
  gradesList.forEach(x=>{
    let o=document.createElement("option");
    o.textContent=x;
    g.appendChild(o);
  });
}
fillGrades();

/* load subjects for filter when grade selected */
document.getElementById("filter_grade").onchange=async ()=>{
  let grade=document.getElementById("filter_grade").value;
  let subj=document.getElementById("filter_subject");
  subj.innerHTML="<option value=''>كل المواد</option>";

  let d=await db.collection("settings").doc("subjects_"+grade).get();
  if(d.exists){
    (d.data().subjects||[]).forEach(s=>{
      let o=document.createElement("option");
      o.textContent=s.name;
      subj.appendChild(o);
    });
  }
};

function getRateName(p){
  if(p>=90) return "ممتاز";
  if(p>=80) return "جيد جدًا";
  if(p>=70) return "جيد";
  if(p>=60) return "مقبول";
  return "ضعيف";
}

/* =================== MAIN LOAD =================== */
async function loadAll(){

  let grade=document.getElementById("filter_grade").value;
  let section=document.getElementById("filter_section").value;
  let ratingFilter=document.getElementById("filter_rating").value;
  let subjectFilter=document.getElementById("filter_subject").value;

  let body=document.getElementById("students_body");
  body.innerHTML="";

  /* load students */
  let q=db.collection("students");
  if(grade) q=q.where("grade","==",grade);
  if(section) q=q.where("section","==",section);

  let snap=await q.get();

  /* load official subjects */
  let offDoc=grade
    ? await db.collection("settings").doc("subjects_"+grade).get()
    : null;

  let officialSubs={};
  if(offDoc?.exists){
    offDoc.data().subjects.forEach(s=>{
      officialSubs[s.name]=Number(s.fullMark);
    });
  }

  snap.forEach(stuDoc=>{
    let st=stuDoc.data();
    let subs=st.subjects||{};

    Object.keys(officialSubs).forEach(subName=>{

      let correctFull = officialSubs[subName];
      let mark = subs[subName]?.mark ?? null;

      /* missing mark: 0 or empty */
      let isMissing = (mark===0 || mark==="" || mark===null);

      /* fix incorrect fullMark */
      let pct = isMissing ? 0 : ((mark / correctFull) * 100).toFixed(1);

      let rate = isMissing ? "ناقص" : getRateName(pct);

      /* apply filters */
      if(subjectFilter && subjectFilter!==subName) return;

      if(ratingFilter==="missing" && !isMissing) return;
      if(ratingFilter==="weak" && !(!isMissing && pct<60)) return;
      if(ratingFilter==="excellent" && !(pct>=90)) return;
      if(ratingFilter==="verygood" && !(pct>=80 && pct<90)) return;
      if(ratingFilter==="good" && !(pct>=70 && pct<80)) return;

      let tr=document.createElement("tr");

      if(isMissing) tr.classList.add("missing");
      else if(pct<60) tr.classList.add("low");

      tr.innerHTML=`
        <td>${st.name}</td>
        <td>${st.grade}</td>
        <td>${st.section}</td>
        <td>${subName}</td>
        <td>${isMissing ? "—" : mark}</td>
        <td>${correctFull}</td>
        <td>${isMissing ? "—" : pct+"%"}</td>
        <td>${rate}</td>
      `;
      body.appendChild(tr);

    });

  });
}

</script>

</body>
</html>
