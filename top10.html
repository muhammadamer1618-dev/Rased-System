<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>أفضل 10 طلاب - نظام راصد</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{font-family:Calibri;background:#f4f4f4;margin:0;padding:20px}
.container{max-width:900px;margin:auto;background:white;padding:20px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,0.2)}

h1{text-align:center;color:#1976d2;margin-bottom:15px}
label{font-weight:bold}
select,button{
  padding:10px;
  font-size:16px;
  border-radius:8px;
  border:1px solid #999;
}
button{cursor:pointer;background:#1976d2;color:white;font-weight:bold}
button:hover{opacity:0.9}

table{width:100%;border-collapse:collapse;margin-top:20px;font-size:16px}
th,td{border:1px solid #888;padding:8px;text-align:center}
th{background:#1976d2;color:white}

.rank{font-weight:bold;color:#d32f2f}
</style>
</head>
<body>

<div class="container">

  <h1>أفضل 10 طلاب في الفصل</h1>

  <label>اختر الصف</label>
  <select id="grade"></select>

  <label style="margin-left:15px">اختر الشعبة</label>
  <select id="section">
    <option>أ</option>
    <option>ب</option>
    <option>ج</option>
  </select>

  <button onclick="loadTop10()" style="margin-left:15px;">عرض</button>

  <table id="top10_table" style="display:none;">
    <thead>
      <tr>
        <th>الترتيب</th>
        <th>الاسم</th>
        <th>الصف</th>
        <th>الشعبة</th>
        <th>المجموع</th>
        <th>إجمالي الدرجات</th>
        <th>النسبة</th>
        <th>التقدير</th>
      </tr>
    </thead>
    <tbody id="top10_body"></tbody>
  </table>

</div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain: "results2026-7c0dd.firebaseapp.com",
  projectId: "results2026-7c0dd",
  storageBucket: "results2026-7c0dd.firebasestorage.app",
  messagingSenderId: "241421115694",
  appId: "1:241421115694:web:96f55fd9fd1d5b18b31abf"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

var gradesList=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

(function fillGrades(){
  let g=document.getElementById("grade");
  gradesList.forEach(x=>{
    let o=document.createElement("option");
    o.textContent=x;
    g.appendChild(o);
  });
})();

function getRate(p){
  if(p>=90)return"ممتاز";
  if(p>=80)return"جيد جدًا";
  if(p>=70)return"جيد";
  if(p>=60)return"مقبول";
  return"ضعيف";
}

async function loadTop10(){
  let grade=document.getElementById("grade").value;
  let section=document.getElementById("section").value;

  let snap=await db.collection("students")
    .where("grade","==",grade)
    .where("section","==",section)
    .get();

  let list=[];

  snap.forEach(doc=>{
    let st=doc.data();
    let subs=st.subjects||{};
    let total=0, full=0;

    Object.keys(subs).forEach(sub=>{
      let m=subs[sub].mark||0;
      let f=subs[sub].fullMark||0;

      if(f>0){
        total+=Number(m);
        full+=Number(f);
      }
    });

    if(full>0){
      let pct=(total/full)*100;
      list.push({
        name:st.name,
        grade:st.grade,
        section:st.section,
        total:total,
        full:full,
        pct:pct.toFixed(1),
        rating:getRate(pct)
      });
    }
  });

  list.sort((a,b)=>b.total-a.total);
  let top10=list.slice(0,10);

  let body=document.getElementById("top10_body");
  body.innerHTML="";
  top10.forEach((s,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="rank">${i+1}</td>
      <td>${s.name}</td>
      <td>${s.grade}</td>
      <td>${s.section}</td>
      <td>${s.total}</td>
      <td>${s.full}</td>
      <td>${s.pct}%</td>
      <td>${s.rating}</td>
    `;
    body.appendChild(tr);
  });

  document.getElementById("top10_table").style.display="table";
}
</script>

</body>
</html>
