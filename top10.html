<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ترتيب أوائل الطلاب - نظام راصد</title>

<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#f4f4f4;
  margin:0;
  padding:20px;
}

.container{
  max-width:950px;
  margin:auto;
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 0 10px rgba(0,0,0,0.15);
  text-align:center;
}

h1{
  color:#d4af37;
  font-size:32px;
  margin-bottom:5px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
}

label{
  font-weight:bold;
  margin-left:10px;
}

select,button{
  padding:10px;
  font-size:17px;
  border-radius:8px;
  border:1px solid #999;
  margin:5px;
}

button{
  cursor:pointer;
  background:#d4af37;
  color:white;
  border:none;
  font-weight:bold;
}

button:hover{
  opacity:0.9;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  font-size:16px;
}

th,td{
  border:1px solid #aaa;
  padding:8px;
  text-align:center;
}

th{
  background:#d4af37;
  color:white;
}

.rank{
  font-weight:bold;
  color:#c08922;
  font-size:18px;
}
</style>
</head>
<body>

<div class="container">

  <h1>
    <!-- GOLD ICON -->
    <svg width="45" height="45" viewBox="0 0 24 24" fill="#d4af37">
      <path d="M17 3H7V5H3V6C3 8.97 5.16 11.43 8 11.91V19H6V21H18V19H16V11.91C18.84 11.43 21 8.97 21 6V5H17V3ZM5.17 7C5.06 6.69 5 6.35 5 6H7V7.93C6.28 7.74 5.64 7.42 5.17 7ZM19 6C19 6.35 18.94 6.69 18.83 7C18.36 7.42 17.72 7.74 17 7.93V6H19Z"/>
    </svg>

    ترتيب أوائل الطلاب
  </h1>

  <label>اختر الصف:</label>
  <select id="grade"></select>

  <label>الشعبة:</label>
  <select id="section">
    <option>أ</option>
    <option>ب</option>
    <option>ج</option>
  </select>

  <label>عدد الطلاب:</label>
  <select id="limit">
    <option value="3">أفضل 3</option>
    <option value="5">أفضل 5</option>
    <option value="10" selected>أفضل 10</option>
  </select>

  <button onclick="loadTop()">عرض الترتيب</button>

  <table id="top_table" style="display:none;">
    <thead>
      <tr>
        <th>الترتيب</th>
        <th>الاسم</th>
        <th>الصف</th>
        <th>الشعبة</th>
        <th>المجموع</th>
        <th>إجمالي الدرجات</th>
        <th>النسبة</th>
        <th>التقدير</th>
      </tr>
    </thead>
    <tbody id="top_body"></tbody>
  </table>

</div>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain: "results2026-7c0dd.firebaseapp.com",
  projectId: "results2026-7c0dd",
  storageBucket: "results2026-7c0dd.firebasestorage.app",
  messagingSenderId: "241421115694",
  appId: "1:241421115694:web:96f55fd9fd1d5b18b31abf"
};

firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

var gradesList=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

(function fillGrades(){
  let g=document.getElementById("grade");
  gradesList.forEach(x=>{
    let o=document.createElement("option");
    o.textContent=x;
    g.appendChild(o);
  });
})();

function getRate(p){
  if(p>=90)return"ممتاز";
  if(p>=80)return"جيد جدًا";
  if(p>=70)return"جيد";
  if(p>=60)return"مقبول";
  return"ضعيف";
}

async function loadTop(){
  let grade=document.getElementById("grade").value;
  let section=document.getElementById("section").value;
  let limit=Number(document.getElementById("limit").value);

  let snap=await db.collection("students")
    .where("grade","==",grade)
    .where("section","==",section)
    .get();

  let list=[];

  snap.forEach(doc=>{
    let st=doc.data();
    let subs=st.subjects||{};
    let total=0, full=0;

    Object.keys(subs).forEach(sub=>{
      let m=subs[sub].mark||0;
      let f=subs[sub].fullMark||0;

      if(f>0){
        total+=Number(m);
        full+=Number(f);
      }
    });

    if(full>0){
      let pct=(total/full)*100;
      list.push({
        name:st.name,
        grade:st.grade,
        section:st.section,
        total:total,
        full:full,
        pct:pct.toFixed(1),
        rating:getRate(pct)
      });
    }
  });

  list.sort((a,b)=>b.total-a.total);
  let top=list.slice(0, limit);

  let body=document.getElementById("top_body");
  body.innerHTML="";

  top.forEach((s,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="rank">${i+1}</td>
      <td>${s.name}</td>
      <td>${s.grade}</td>
      <td>${s.section}</td>
      <td>${s.total}</td>
      <td>${s.full}</td>
      <td>${s.pct}%</td>
      <td>${s.rating}</td>
    `;
    body.appendChild(tr);
  });

  document.getElementById("top_table").style.display="table";
}
</script>

</body>
</html>
