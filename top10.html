<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ترتيب أوائل الطلاب</title>
<link href="https://fonts.googleapis.com/css2?family=Calibri:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Calibri;
  background:#f2f4f8;
  margin:0;
  padding:20px;
}
.container{
  max-width:900px;
  margin:auto;
  background:white;
  padding:20px;
  border-radius:14px;
  box-shadow:0 0 12px rgba(0,0,0,0.15);
}
h1{
  text-align:center;
  color:#d4a017;
  font-size:32px;
  font-weight:bold;
}
.logo{
  width:70px;
  display:block;
  margin:auto;
}
.select-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:15px;
}
select,button{
  font-family:Calibri;
  font-size:16px;
  padding:10px;
  border-radius:7px;
  border:1px solid #777;
}
button{
  background:#d4a017;
  color:white;
  font-weight:bold;
  cursor:pointer;
  border:none;
}
button:hover{opacity:0.92}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  font-size:16px;
}
th,td{
  border:1px solid #aaa;
  padding:8px;
  text-align:center;
}
th{
  background:#d4a017;
  color:white;
}
.rank{
  font-weight:bold;
  color:#d4a017;
}
</style>
</head>

<body>
<div class="container">

  <img class="logo" src="https://cdn-icons-png.flaticon.com/512/2583/2583343.png">

  <h1>ترتيب أوائل الطلاب</h1>

  <div class="select-row">
    <select id="grade"></select>

    <select id="section">
      <option>أ</option>
      <option>ب</option>
      <option>ج</option>
    </select>

    <select id="limit">
      <option value="3">أفضل 3</option>
      <option value="5">أفضل 5</option>
      <option value="10" selected>أفضل 10</option>
    </select>

    <button onclick="loadTop()">عرض الترتيب</button>
  </div>

  <div id="result"></div>

</div>

<script>
var firebaseConfig = {
  apiKey:"AIzaSyAfgSV-6_IMkXncgPWxY69omKfvFtGakgk",
  authDomain:"results2026-7c0dd.firebaseapp.com",
  projectId:"results2026-7c0dd",
  storageBucket:"results2026-7c0dd.firebasestorage.app",
  messagingSenderId:"241421115694",
  appId:"1:241421115694:web:96f55fd9fd1d5b18b31abf"
};

firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

var gradesList=[
 "1 ابتدائي","2 ابتدائي","3 ابتدائي","4 ابتدائي","5 ابتدائي","6 ابتدائي",
 "1 متوسط","2 متوسط","3 متوسط",
 "1 ثانوي","2 ثانوي","3 ثانوي"
];

function fillGrades(){
  let g=document.getElementById("grade");
  gradesList.forEach(x=>{
    let o=document.createElement("option");
    o.textContent=x;
    g.appendChild(o);
  });
}
fillGrades();

async function loadTop(){
  let grade=document.getElementById("grade").value;
  let section=document.getElementById("section").value;
  let limit=parseInt(document.getElementById("limit").value);

  let res=document.getElementById("result");
  res.innerHTML="جار التحميل...";

  let q=await db.collection("students")
    .where("grade","==",grade)
    .where("section","==",section)
    .get();

  let list=[];
  q.forEach(d=>{
    let st=d.data();
    let subs = st.subjects || {};

    let total = 0;
    let totalFull = 0;

    Object.keys(subs).forEach(sub=>{
      let m = subs[sub].mark || 0;
      let f = subs[sub].fullMark || 0;

      if(f > 100) f = 100;
      if(m > f) m = f;
      if(f <= 0) return;
      if(m < 0) m = 0;

      total += m;
      totalFull += f;
    });

    list.push({
      name:st.name,
      code:st.code,
      total:total,
      full:totalFull
    });
  });

  list.sort((a,b)=>b.total - a.total);

  let top=list.slice(0,limit);

  let html=`<table>
    <tr>
      <th>الترتيب</th>
      <th>الاسم</th>
      <th>الكود</th>
      <th>المجموع</th>
      <th>النسبة</th>
    </tr>
  `;

  top.forEach((st,i)=>{
    let pct = st.full ? ((st.total/st.full)*100).toFixed(1) : "0";
    html+=`
      <tr>
        <td class="rank">${i+1}</td>
        <td>${st.name}</td>
        <td>${st.code}</td>
        <td>${st.total} / ${st.full}</td>
        <td>${pct}%</td>
      </tr>
    `;
  });

  html+=`</table>`;
  res.innerHTML=html;
}
</script>

</body>
</html>
